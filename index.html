<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Hunt - FF14 Hunt Tracker</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons for Map/Tabs -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Custom Font and Configuration for Tailwind */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        
        /* Tailwind Custom Configuration */
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-dark': '#1e293b', /* Slate 800 */
                        'secondary-dark': '#334155', /* Slate 700 */
                        'accent-blue': '#3b82f6', /* Blue 500 */
                        'indigo-outline': '#4f46e5', /* Indigo 600 */
                        'pastel-green': '#a7f3d0', /* Teal/Green for 100% progress */
                        'pastel-yellow': '#fde047', /* Yellow for 0% progress */
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    maxWidth: {
                        '512': '512px', /* Max width for single column card */
                    }
                }
            }
        }
        
        /* Dark Mode Base Styles */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a; /* Slate 900 */
            color: #f8fafc; /* Slate 50 */
            transition: background-color 0.3s;
        }

        /* Text Outline Effect (Indigo/Navyã§ã‚¢ã‚¦ãƒˆãƒ©ã‚¤ãƒ³) */
        .text-outline {
            text-shadow: 
                1.5px 1.5px 0 #4f46e5, 
                -1.5px 1.5px 0 #4f46e5, 
                1.5px -1.5px 0 #4f46e5, 
                -1.5px -1.5px 0 #4f46e5;
        }

        /* Custom Transition for Card Details (ã‚¹ãƒ©ã‚¤ãƒ‰ãƒ€ã‚¦ãƒ³) */
        .details-slide {
            transition: max-height 0.3s ease-in-out, opacity 0.3s ease-in-out;
            max-height: 0;
            overflow: hidden;
            opacity: 0;
        }
        .details-slide.active {
            max-height: 500px; 
            opacity: 1;
        }

        /* ãƒ¢ãƒ–ä¸€è¦§ã‚°ãƒªãƒƒãƒ‰ã®ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–èª¿æ•´ */
        #mob-list-container {
            /* ãƒ¢ãƒã‚¤ãƒ« (1ã‚«ãƒ©ãƒ ) */
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        }
        @media (min-width: 768px) {
             /* ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆ (1ã‚«ãƒ©ãƒ  512px) */
            #mob-list-container {
                grid-template-columns: repeat(auto-fit, minmax(512px, 1fr));
            }
        }
        @media (min-width: 1280px) { 
            /* PC (æœ€å¤§3ã‚«ãƒ©ãƒ ) */
            #mob-list-container {
                grid-template-columns: repeat(3, minmax(300px, 1fr));
            }
        }


        /* Map Container (ç¸¦æ¨ª500pxå›ºå®š) */
        .map-container {
            width: 500px;
            height: 500px;
            max-width: 100%; /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ */
            max-height: 100vw; /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ */
            position: relative;
            background-color: #000;
            margin: 0 auto;
            border-radius: 0.5rem;
            overflow: hidden;
        }
        .map-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            user-select: none;
        }

        /* Pop Point Circle (åº§æ¨™ç‚¹) */
        .pop-point {
            position: absolute;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            border: 2px solid #000;
            transform: translate(-50%, -50%); /* åº§æ¨™ã«ä¸­å¤®ã‚’åˆã‚ã›ã‚‹ */
            cursor: pointer;
            transition: background-color 0.2s;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.7);
        }

        /* Pop Point Colors (çŠ¶æ…‹) */
        .pop-point.status-candidate {
            background-color: #10b981; /* ç·‘: POPå€™è£œåœ° */
        }
        .pop-point.status-checked {
            background-color: #ef4444; /* èµ¤: POPéå€™è£œåœ°ï¼ˆãƒã‚§ãƒƒã‚¯æ¸ˆã¿ï¼‰ */
        }

        /* Progress Bar Styling (ã‚²ãƒ¼ã‚¸) */
        .progress-background {
            position: relative;
            overflow: hidden;
        }
        .progress-bar {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            transition: width 0.5s ease-out, background-color 0.5s;
            z-index: 1;
            /* 0% (ãƒ‘ã‚¹ãƒ†ãƒ«ã‚¤ã‚¨ãƒ­ãƒ¼) ã‹ã‚‰ 100% (ãƒ‘ã‚¹ãƒ†ãƒ«ã‚°ãƒªãƒ¼ãƒ³) ã®ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ */
            background: linear-gradient(to right, #fde047, #a7f3d0); 
        }
        .progress-content {
            position: relative;
            z-index: 2;
        }

    </style>
</head>
<body class="min-h-screen p-4 sm:p-6 md:p-8">

    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-4xl sm:text-5xl font-extrabold text-white mb-2">The Hunt</h1>
            <p class="text-gray-400 mb-4">FF14 ãƒ¢ãƒ–ãƒãƒ³ãƒˆè¨ä¼ãƒ»ãƒªãƒãƒƒãƒ—ãƒˆãƒ©ãƒƒã‚«ãƒ¼</p>
            
            <!-- Maintenance Banner Area -->
            <div id="maintenance-banner" class="hidden mx-auto p-3 bg-red-800/50 border-l-4 border-red-500 rounded-lg max-w-lg text-red-300 font-semibold text-sm">
                <!-- ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹æƒ…å ±ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ (èµ¤æ–‡å­—) -->
            </div>

            <!-- UUID Message -->
            <div id="system-message" class="mt-4 p-3 bg-blue-900/50 border-l-4 border-blue-400 rounded-lg max-w-lg mx-auto text-blue-300 hidden">
                <!-- åŒ¿åIDæƒ…å ± -->
            </div>

        </header>

        <!-- Tabs for Filtering -->
        <div class="flex justify-center space-x-2 sm:space-x-4 mb-6 sticky top-0 bg-[#0f172a] z-10 py-3 border-b border-secondary-dark">
            <button class="tab-button px-4 py-2 text-sm sm:text-base rounded-full transition-colors font-semibold" data-rank="all">ALL</button>
            <button class="tab-button px-4 py-2 text-sm sm:text-base rounded-full transition-colors font-semibold" data-rank="S">Sãƒ©ãƒ³ã‚¯</button>
            <button class="tab-button px-4 py-2 text-sm sm:text-base rounded-full transition-colors font-semibold" data-rank="A">Aãƒ©ãƒ³ã‚¯</button>
            <button class="tab-button px-4 py-2 text-sm sm:text-base rounded-full transition-colors font-semibold" data-rank="FATE">FATE</button>
        </div>
        
        <!-- ãƒ¢ãƒ–ä¸€è¦§ã‚³ãƒ³ãƒ†ãƒŠ -->
        <div id="mob-list-container" class="grid gap-6 justify-center">
            <div id="loading-indicator" class="col-span-full text-center p-12 text-gray-500">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
        </div>

    </div>

    <!-- è¨ä¼å ±å‘Šãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="report-modal" class="fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-50 hidden p-4">
        <div class="bg-primary-dark p-6 rounded-xl shadow-2xl max-w-lg w-full border border-secondary-dark">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">è¨ä¼å ±å‘Š</h2>
                <button class="close-button text-gray-400 hover:text-white transition-colors">&times;</button>
            </div>
            
            <p class="mb-4 text-sm text-gray-400">
                <span id="modal_mob_display" class="text-lg font-bold text-accent-blue"></span> 
                ã®è¨ä¼ã‚’å ±å‘Šã—ã¾ã™ã€‚
            </p>

            <form id="report-form" class="space-y-4">
                <!-- éš ã—ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ (ãƒ¢ãƒ–æƒ…å ±ã¨åŒ¿åID) -->
                <input type="hidden" id="report_mobName" name="mob_name">
                <input type="hidden" id="report_mobRank" name="mob_rank">
                <input type="hidden" id="report_area" name="area">
                <input type="hidden" id="report_reporterId" name="reporter_id">
                <input type="hidden" name="reportType" value="hunt">

                <!-- è¨ä¼æ—¥æ™‚ (JST) -->
                <div>
                    <label for="report_time" class="block text-sm font-medium text-gray-300">è¨ä¼æ—¥æ™‚ (JST):</label>
                    <input type="datetime-local" id="report_time" name="report_time" required 
                           class="w-full mt-1 p-2 bg-secondary-dark border border-gray-600 rounded-md text-white">
                </div>
                
                <!-- ãƒ¯ãƒ¼ãƒ«ãƒ‰å -->
                <div>
                    <label for="report_world" class="block text-sm font-medium text-gray-300">ãƒ¯ãƒ¼ãƒ«ãƒ‰å (ä»»æ„):</label>
                    <input type="text" id="report_world" name="world" placeholder="ä¾‹: Garuda"
                           class="w-full mt-1 p-2 bg-secondary-dark border border-gray-600 rounded-md text-white">
                </div>

                <!-- ETè¨ä¼æ™‚é–“ (ä»»æ„) -->
                <div>
                    <label for="report_etTime" class="block text-sm font-medium text-gray-300">ETè¨ä¼æ™‚é–“ (HH:MM ä»»æ„):</label>
                    <input type="text" id="report_etTime" name="et_time" placeholder="ä¾‹: 19:30"
                           class="w-full mt-1 p-2 bg-secondary-dark border border-gray-600 rounded-md text-white">
                </div>

                <!-- é€ä¿¡ãƒœã‚¿ãƒ³ã¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
                <div class="pt-4">
                    <button type="submit" id="submit-report-button"
                            class="w-full bg-accent-blue hover:bg-blue-700 text-white font-bold py-2 rounded-md transition duration-200 shadow-lg">
                        å ±å‘Šã‚’é€ä¿¡
                    </button>
                    <div id="message" class="hidden mt-3 p-2 rounded-lg text-center font-medium"></div>
                </div>
            </form>
        </div>
    </div>
    
    <script>
    // =================================================================================
    // ğŸš¨ å¿…é ˆ: ã“ã“ã«Google Apps Script Web Appã®ãƒ‡ãƒ—ãƒ­ã‚¤URLã‚’è¨­å®šã—ã¦ãã ã•ã„ ğŸš¨
    // =================================================================================
    const GAS_API_URL = 'https://script.google.com/macros/s/AKfycbwFoWTenTJi8PoCUWUwo1JU1JJOgZKLfr8ILVXez0FvHO2NTzl-1BKr12LLJWSHoTXPyQ/exec'; 
    // =================================================================================

    // DOMè¦ç´ ã®å–å¾—
    const mobListContainer = document.getElementById('mob-list-container');
    const modal = document.getElementById('report-modal'); // ãƒ¢ãƒ¼ãƒ€ãƒ«æœ¬ä½“
    const closeButton = document.getElementsByClassName('close-button')[0];
    const reportForm = document.getElementById('report-form');
    const reportTimeInput = document.getElementById('report_time');
    const messageElement = document.getElementById('message');
    const submitButton = document.getElementById('submit-report-button');
    const tabButtons = document.querySelectorAll('.tab-button');
    const maintenanceBanner = document.getElementById('maintenance-banner');
    const systemMessageElement = document.getElementById('system-message');
    const modalMobDisplay = document.getElementById('modal_mob_display'); // ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã®ãƒ¢ãƒ–åè¡¨ç¤º

    // ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ‡ãƒ¼ã‚¿ã‚¹ãƒˆã‚¢
    let globalMobConfig = {};
    let globalHuntList = [];
    let globalLocationDef = {};
    let globalLocationState = [];
    let currentFilterRank = 'all';
    
    // åŒ¿åå ±å‘Šè€…ID (UUID) ã®å‡¦ç†
    const REPORTER_ID_KEY = 'hunt_reporter_uuid';
    let REPORTER_UUID = localStorage.getItem(REPORTER_ID_KEY);

    if (!REPORTER_UUID) {
        REPORTER_UUID = self.crypto.randomUUID(); 
        localStorage.setItem(REPORTER_ID_KEY, REPORTER_UUID);
        systemMessageElement.textContent = \`åŒ¿åå ±å‘Šè€…IDã‚’ç”Ÿæˆã—ã¾ã—ãŸ: ${REPORTER_UUID.substring(0, 8)}...\`;
        systemMessageElement.classList.remove('hidden');
    } else {
        systemMessageElement.textContent = \`åŒ¿åå ±å‘Šè€…IDã‚’ä½¿ç”¨ä¸­: ${REPORTER_UUID.substring(0, 8)}...\`;
        systemMessageElement.classList.remove('hidden');
    }

    // ==============================================================================
    // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
    // ==============================================================================

    /**
     * UTCæ™‚é–“ã‚’JSTã®æ–‡å­—åˆ—ã«å¤‰æ›
     */
    function formatTimeToJST(utcIsoString) {
        if (!utcIsoString) return 'æœªå ±å‘Š';
        const utcTime = new Date(utcIsoString);
        return utcTime.toLocaleString('ja-JP', {
            year: 'numeric', month: '2-digit', day: '2-digit',
            hour: '2-digit', minute: '2-digit', second: '2-digit',
            timeZone: 'Asia/Tokyo'
        });
    }

    /**
     * ç¾åœ¨æ™‚åˆ»ã‚’ <input type="datetime-local"> å½¢å¼ã«ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
     */
    function getCurrentDateTimeLocal() {
        const now = new Date();
        now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
        return now.toISOString().slice(0, 16);
    }
    
    /**
     * ET (ã‚¨ã‚ªãƒ«ã‚¼ã‚¢æ™‚é–“) é–¢é€£ã®ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
     */
    const ET_RATIO = 3600 / 70; 
    
    function calculateET(ltDate) {
        const BASE_LT = new Date('2010-01-01T00:00:00Z').getTime();
        const currentLT = ltDate.getTime();
        const elapsedLT = currentLT - BASE_LT;
        const elapsedET = elapsedLT * ET_RATIO;
        const etDate = new Date(BASE_LT + elapsedET);
        return etDate;
    }

    function isETConditionMet(conditionString, etHour) {
        if (!conditionString) return true;
        
        const periods = conditionString.split('/').map(p => p.trim()).filter(Boolean);

        for (const period of periods) {
            const match = period.match(/(\d{1,2}):\d{2}-(\d{1,2}):\d{2}/);
            if (!match) continue;

            const startHour = parseInt(match[1], 10);
            const endHour = parseInt(match[2], 10);
            
            // çµ‚äº†æ™‚åˆ»ãŒé–‹å§‹æ™‚åˆ»ã‚ˆã‚Šå°ã•ã„å ´åˆã¯æ—¥ã‚’ã¾ãŸãï¼ˆä¾‹: 22æ™‚-02æ™‚ï¼‰
            if (startHour > endHour) {
                if (etHour >= startHour || etHour < endHour) return true;
            } else {
                if (etHour >= startHour && etHour < endHour) return true; 
            }
        }
        return false;
    }
    
    // --- å¤©å€™äºˆæ¸¬ãƒ­ã‚¸ãƒƒã‚¯ ---
    // (å¤©å€™åˆ¤å®šã¯å¤©å€™æ¡ä»¶ãŒæŒ‡å®šã•ã‚ŒãŸéš›ã«å®Ÿè£…ã™ã‚‹ãŸã‚ã€ç¾åœ¨ã¯ã‚¹ã‚­ãƒƒãƒ—)
    
    // ==============================================================================
    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã¨ãƒ•ã‚©ãƒ¼ãƒ å‡¦ç†
    // ==============================================================================
    
    /**
     * è¨ä¼å ±å‘Šãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
     */
    function openReportModal(mobData) {
        // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
        reportForm.reset();
        
        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã«ãƒ¢ãƒ–åã‚’è¡¨ç¤º
        modalMobDisplay.textContent = mobData['ãƒ¢ãƒ–å'];

        // éš ã—ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«ãƒ‡ãƒ¼ã‚¿ã‚’ã‚»ãƒƒãƒˆ
        document.getElementById('report_mobName').value = mobData['ãƒ¢ãƒ–å'];
        document.getElementById('report_mobRank').value = mobData['ãƒ©ãƒ³ã‚¯'];
        document.getElementById('report_area').value = mobData['ã‚¨ãƒªã‚¢å'];
        document.getElementById('report_reporterId').value = REPORTER_UUID;

        // è¨ä¼æ—¥æ™‚ã‚’ç¾åœ¨æ™‚åˆ»ã«è¨­å®š
        reportTimeInput.value = getCurrentDateTimeLocal();

        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚¯ãƒªã‚¢ã—ã¦ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
        messageElement.classList.add('hidden');
        submitButton.disabled = false;
        submitButton.textContent = 'å ±å‘Šã‚’é€ä¿¡';
        modal.classList.remove('hidden');
    }

    /**
     * è¨ä¼å ±å‘Šãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
     */
    function closeReportModal() {
        modal.classList.add('hidden');
    }

    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹ãŸã‚ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
    closeButton.addEventListener('click', closeReportModal);
    modal.addEventListener('click', (e) => {
        if (e.target === modal) {
            closeReportModal();
        }
    });

    /**
     * è¨ä¼å ±å‘Šãƒ•ã‚©ãƒ¼ãƒ ã®é€ä¿¡å‡¦ç†
     */
    reportForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        // UIã®æ›´æ–°
        submitButton.disabled = true;
        submitButton.textContent = 'é€ä¿¡ä¸­...';
        messageElement.classList.add('hidden');

        // ãƒ•ã‚©ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
        const formData = new FormData(this);
        const payload = {};
        for (const [key, value] of formData.entries()) {
            payload[key] = value;
        }

        try {
            const response = await fetch(GAS_API_URL, {
                method: 'POST',
                mode: 'cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const result = await response.json();
            
            if (result.status === 'success') {
                messageElement.textContent = \`å ±å‘ŠæˆåŠŸ: \${result.message}\`;
                messageElement.classList.remove('hidden', 'bg-red-500/20', 'text-red-300');
                messageElement.classList.add('bg-green-500/20', 'text-green-300');
                
                // æˆåŠŸã—ãŸã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å†å–å¾—ã—ã¦è¡¨ç¤ºã‚’æ›´æ–°
                await initApp();
                
                // 3ç§’å¾Œã«ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
                setTimeout(closeReportModal, 3000); 

            } else {
                messageElement.textContent = \`å ±å‘Šå¤±æ•—: \${result.message}\`;
                messageElement.classList.remove('hidden', 'bg-green-500/20', 'text-green-300');
                messageElement.classList.add('bg-red-500/20', 'text-red-300');
            }
        } catch (error) {
            messageElement.textContent = 'é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚GASã®URLã¾ãŸã¯æ¨©é™ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
            messageElement.classList.remove('hidden', 'bg-green-500/20', 'text-green-300');
            messageElement.classList.add('bg-red-500/20', 'text-red-300');
            console.error('Fetch error:', error);
        } finally {
            submitButton.disabled = false;
            submitButton.textContent = 'å ±å‘Šã‚’é€ä¿¡';
        }
    });

    // ==============================================================================
    // ãƒ¡ã‚¤ãƒ³æ©Ÿèƒ½: ãƒ‡ãƒ¼ã‚¿å–å¾—ã¨ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
    // ==============================================================================

    /**
     * GASã‹ã‚‰å…¨ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã€ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã«ä¿å­˜ã™ã‚‹
     */
    async function fetchAllData() {
        if (GAS_API_URL === 'YOUR_GAS_WEB_APP_URL') {
             throw new Error("GAS API URLãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ã‚³ãƒ¼ãƒ‰å†…ã® 'YOUR_GAS_WEB_APP_URL' ã‚’ä¿®æ­£ã—ã¦ãã ã•ã„ã€‚");
        }
        
        const response = await fetch(GAS_API_URL);
        const result = await response.json();

        if (result.status === 'success') {
            globalMobConfig = result.mobConfig.reduce((acc, mob) => {
                acc[mob['ãƒ¢ãƒ–å']] = mob;
                return acc;
            }, {});
            globalHuntList = result.huntList;
            
            // åº§æ¨™å®šç¾©ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ¢ãƒ–åã§ãƒãƒƒãƒ—åŒ–
            globalLocationDef = result.locationDef.reduce((acc, loc) => {
                if (!acc[loc['ãƒ¢ãƒ–å']]) acc[loc['ãƒ¢ãƒ–å']] = [];
                acc[loc['ãƒ¢ãƒ–å']].push(loc);
                return acc;
            }, {});
            globalLocationState = result.locationState;
            
            handleMaintenanceBanner(result.maintenance);

        } else {
             console.error("GASãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:", result.message);
             mobListContainer.innerHTML = `<p class="col-span-full text-red-400">ãƒ‡ãƒ¼ã‚¿å–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${result.message}</p>`;
             throw new Error(result.message);
        }
    }

    /**
     * Lodestoneãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹æƒ…å ±ã®è¡¨ç¤ºã‚’åˆ¶å¾¡ã™ã‚‹
     */
    function handleMaintenanceBanner(info) {
        const targetString = "æ—¥ã€€æ™‚ï¼š";
        if (!info.startsWith(targetString)) {
            maintenanceBanner.classList.add('hidden');
            return;
        }

        // çµ‚äº†æ—¥æ™‚ã‚’æŠ½å‡ºï¼ˆè¤‡æ•°è¡Œã«å¯¾å¿œï¼‰
        const dateParts = info.match(/(\d{4}å¹´\d{1,2}æœˆ\d{1,2}æ—¥)ï¼ˆ[^ï¼‰]+?ï¼‰(\d{1,2}ï¼š\d{2})ã”ã‚?ï½\s*(\d{4}å¹´\d{1,2}æœˆ\d{1,2}æ—¥)?ï¼ˆ[^ï¼‰]+?ï¼‰?(\d{1,2}ï¼š\d{2})ã”ã‚/);
        
        if (!dateParts) {
            maintenanceBanner.classList.add('hidden');
            return;
        }

        // çµ‚äº†æ—¥æ™‚ã‚’ãƒ‘ãƒ¼ã‚¹
        const endDateStr = (dateParts[3] ? dateParts[3].replace(/å¹´|æœˆ/g, '/').replace(/æ—¥/g, '') : dateParts[1].replace(/å¹´|æœˆ/g, '/').replace(/æ—¥/g, '')) + ' ' + dateParts[4];
        const endTime = new Date(endDateStr.replace(/(\d{4}\/\d{1,2}\/\d{1,2})\s+(\d{1,2}ï¼š\d{2})/, '$1 $2').replace(/ï¼š/g, ':'));

        const now = new Date();
        // ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹çµ‚äº†æ™‚åˆ» + 3æ—¥é–“
        const threeDaysAfterEnd = new Date(endTime.getTime() + 3 * 24 * 60 * 60 * 1000);
        
        // ç¾åœ¨æ™‚åˆ»ãŒçµ‚äº†æ™‚åˆ»ã‹ã‚‰3æ—¥ä»¥å†…ã§ã‚ã‚Œã°è¡¨ç¤º
        if (now < threeDaysAfterEnd) {
            maintenanceBanner.innerHTML = `
                <p class="text-base">ğŸš¨ **${info}**</p>
                <p class="text-xs mt-1">ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹çµ‚äº†å¾Œ3æ—¥ãŒçµŒéã™ã‚‹ã¾ã§è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>
            `;
            maintenanceBanner.classList.remove('hidden');
        } else {
            maintenanceBanner.classList.add('hidden');
        }
    }

    /**
     * ãƒ¢ãƒ–ä¸€è¦§ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã€ã‚½ãƒ¼ãƒˆã—ã¦è¡¨ç¤ºã™ã‚‹
     */
    function displayMobList() {
        const mobListArray = Object.values(globalMobConfig);
        const lastHuntsMap = getLastHuntsMap(globalHuntList);
        const checkedLocationsMap = getCheckedLocationsMap(globalLocationState);
        const now = new Date();

        // 1. ãƒ‡ãƒ¼ã‚¿åŠ å·¥
        const processedMobs = mobListArray
            .map(mob => {
                const mobName = mob['ãƒ¢ãƒ–å'];
                const lastHunt = lastHuntsMap[mobName];
                const respawnSeconds = parseFloat(mob['ãƒªãƒãƒƒãƒ—é–“éš” (ç§’)']) || 3600;
                
                let progressPercentage = 0;
                let lastKillTime = null;
                let popTimeDisplay = 'æœªå ±å‘Š';
                let popTimeClass = 'text-gray-400';
                
                if (lastHunt) {
                    lastKillTime = lastHunt.killTime;
                    const expectedTime = new Date(lastKillTime.getTime() + respawnSeconds * 1000);
                    
                    const timeElapsed = now.getTime() - lastKillTime.getTime();
                    const totalRespawnTime = respawnSeconds * 1000;
                    
                    progressPercentage = Math.min(100, Math.floor((timeElapsed / totalRespawnTime) * 100));
                    popTimeDisplay = formatTimeToJST(expectedTime.toISOString());

                    if (now > expectedTime) {
                        popTimeClass = 'text-orange-400';
                        progressPercentage = 100;
                    } else if (progressPercentage >= 90) {
                        popTimeClass = 'text-yellow-400';
                    } else {
                        popTimeClass = 'text-green-400';
                    }
                }
                
                const hasMap = globalLocationDef[mobName] && globalLocationDef[mobName].length > 0;

                return {
                    ...mob,
                    lastKillTime: lastKillTime,
                    progress: progressPercentage,
                    popTimeDisplay,
                    popTimeClass,
                    hasMap,
                    checkedLocations: checkedLocationsMap[mobName] || new Set(),
                    locationDef: globalLocationDef[mobName] || []
                };
            })
            // 2. ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
            .filter(mob => currentFilterRank === 'all' || mob['ãƒ©ãƒ³ã‚¯'] === currentFilterRank)
            // 3. ã‚½ãƒ¼ãƒˆ (çµŒéæ™‚é–“ã«åŸºã¥ã„ã¦é™é †)
            .sort((a, b) => b.progress - a.progress); 

        // 4. HTMLç”Ÿæˆ
        const htmlContent = processedMobs.map(mob => createMobCardHTML(mob)).join('');
        
        mobListContainer.innerHTML = htmlContent;

        // 5. ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®å†è¨­å®š
        setupCardEventListeners();
    }
    
    /**
     * ã‚«ãƒ¼ãƒ‰ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆã‚¹ãƒ©ã‚¤ãƒ‰ãƒ€ã‚¦ãƒ³ï¼‰ã‚’è¨­å®š
     */
    function setupCardEventListeners() {
        document.querySelectorAll('.mob-card').forEach(card => {
            // ã‚«ãƒ¼ãƒ‰å…¨ä½“ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
            card.addEventListener('click', (e) => {
                // å ±å‘Šãƒœã‚¿ãƒ³ä¸Šã§ã®ã‚¯ãƒªãƒƒã‚¯ã¯ç„¡è¦–
                if (e.target.closest('.report-button-wrapper')) return; 
                
                const details = card.querySelector('.details-slide');
                const isActive = details.classList.contains('active');
                
                // ä»–ã®é–‹ã„ã¦ã„ã‚‹ã‚«ãƒ¼ãƒ‰ã‚’é–‰ã˜ã‚‹
                document.querySelectorAll('.details-slide.active').forEach(d => {
                    if (d !== details) d.classList.remove('active');
                });
                
                if (!isActive) {
                    details.classList.add('active');
                    // ãƒãƒƒãƒ—ãŒã‚ã‚Œã°æç”»
                    const mobData = JSON.parse(card.getAttribute('data-mob'));
                    const mapElement = card.querySelector('.map-container');
                    if (mapElement) {
                         // ã‚¹ãƒ©ã‚¤ãƒ‰ãƒ€ã‚¦ãƒ³ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å¾Œã«æç”»ã‚’è©¦ã¿ã‚‹
                         setTimeout(() => drawPopPoints(mapElement, mobData), 350); 
                    }
                } else {
                    details.classList.remove('active');
                }
            });
        });
        
        // å ±å‘Šãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
        document.querySelectorAll('.report-button').forEach(button => {
            button.addEventListener('click', (e) => {
                e.stopPropagation(); 
                const mobData = JSON.parse(button.closest('.mob-card').getAttribute('data-mob'));
                openReportModal(mobData);
            });
        });
    }
    
    /**
     * ãƒãƒƒãƒ—ä¸Šã®POPåœ°ç‚¹ã‚’æç”»ã™ã‚‹
     */
    function drawPopPoints(mapContainer, mob) {
        const existingPoints = mapContainer.querySelectorAll('.pop-point');
        existingPoints.forEach(p => p.remove());

        const mapImage = mapContainer.querySelector('img');
        const mapSize = 500; // ç¸¦æ¨ª500pxã§å›ºå®š

        // åº§æ¨™å®šç¾©ãŒãªã‘ã‚Œã°çµ‚äº†
        if (mob.locationDef.length === 0) return;
        
        mob.locationDef.forEach(location => {
            const locationId = location['åº§æ¨™ID'];
            const isChecked = mob.checkedLocations.has(locationId);

            const point = document.createElement('div');
            point.classList.add('pop-point');
            
            // çŠ¶æ…‹ã«åŸºã¥ã„ã¦è‰²ã‚’æ±ºå®š
            point.classList.add(isChecked ? 'status-checked' : 'status-candidate');

            // åº§æ¨™X, Yã¯500x500ã®ç”»åƒåŸºæº–ã§è¨˜éŒ²ã•ã‚Œã¦ã„ã‚‹ã¨ä»®å®š
            const x = parseFloat(location['åº§æ¨™X']);
            const y = parseFloat(location['åº§æ¨™Y']);

            point.style.left = \`${x}px\`;
            point.style.top = \`${y}px\`;
            point.dataset.locationId = locationId;
            point.dataset.mobName = mob['ãƒ¢ãƒ–å'];

            // ãƒãƒƒãƒ—ã®ç‚¹ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¨­å®š
            point.addEventListener('click', (e) => {
                e.stopPropagation();
                handleLocationCheck(mob['ãƒ¢ãƒ–å'], locationId);
            });

            mapContainer.appendChild(point);
        });
    }

    /**
     * POPåœ°ç‚¹ã®ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³å‡¦ç† (éå€™è£œåœ°ã¨ã—ã¦è¨˜éŒ²)
     */
    async function handleLocationCheck(mobName, locationId) {
        // alertã®ä»£ã‚ã‚Šã«confirmã§ç¢ºèª (UIã®éƒ½åˆä¸Šã€ã‚«ã‚¹ã‚¿ãƒ ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã‚’æ¨å¥¨ã—ã¾ã™ãŒã€ä¸€æ—¦ã“ã‚Œã§å®Ÿè£…ã—ã¾ã™)
        const isConfirmed = window.confirm(\`${mobName} ã® ${locationId} åœ°ç‚¹ã‚’ã€ŒPOPéå€™è£œåœ°ã€ã¨ã—ã¦è¨˜éŒ²ã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆã“ã®ãƒ¢ãƒ–ã®è¨ä¼å ±å‘ŠãŒã‚ã‚‹ã¾ã§ã“ã®è¨˜éŒ²ã¯æœ‰åŠ¹ã§ã™ã€‚ï¼‰\`);
        if (!isConfirmed) return;

        const payload = {
            reportType: 'location_check',
            mobName: mobName,
            locationId: locationId,
            reporterId: REPORTER_UUID
        };
        
        try {
            const response = await fetch(GAS_API_URL, {
                method: 'POST',
                mode: 'cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const result = await response.json();
            
            if (result.status === 'success') {
                alert(\`è¨˜éŒ²æˆåŠŸ: \${result.message}\`);
                // æˆåŠŸã—ãŸã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å†å–å¾—ã—ã¦è¡¨ç¤ºã‚’æ›´æ–°
                await initApp();
            } else {
                alert(\`è¨˜éŒ²å¤±æ•—: \${result.message}\`);
            }
        } catch (error) {
            alert('é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚GASã®URLã¾ãŸã¯æ¨©é™ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
        }
    }

    /**
     * æœ€æ–°ã®è¨ä¼å±¥æ­´ã‚’ãƒ¢ãƒ–åã§ãƒãƒƒãƒ—åŒ–
     */
    function getLastHuntsMap(huntList) {
        const lastHunts = {};
        huntList.forEach(hunt => {
            const mobName = hunt['ãƒ¢ãƒ–å'];
            const killTime = new Date(hunt['è¨ä¼æ—¥æ™‚ (UTC)']); 

            if (!lastHunts[mobName] || killTime.getTime() > lastHunts[mobName].killTime.getTime()) {
                lastHunts[mobName] = { killTime };
            }
        });
        return lastHunts;
    }
    
    /**
     * ãƒã‚§ãƒƒã‚¯æ¸ˆã¿ã®åº§æ¨™ã‚’ãƒ¢ãƒ–åã¨åº§æ¨™IDã§ãƒãƒƒãƒ—åŒ–
     */
    function getCheckedLocationsMap(locationState) {
        const checkedLocations = {};
        locationState.forEach(state => {
            const mobName = state['ãƒ¢ãƒ–å'];
            const locationId = state['ãƒã‚§ãƒƒã‚¯æ¸ˆã¿åº§æ¨™ID'];
            if (!checkedLocations[mobName]) {
                checkedLocations[mobName] = new Set();
            }
            checkedLocations[mobName].add(locationId);
        });
        return checkedLocations;
    }
    
    /**
     * ãƒ¢ãƒ–ã‚«ãƒ¼ãƒ‰ã®HTMLã‚’ç”Ÿæˆ
     */
    function createMobCardHTML(mob) {
        const rankClass = mob['ãƒ©ãƒ³ã‚¯'] === 'S' ? 'bg-red-600' : 
                          mob['ãƒ©ãƒ³ã‚¯'] === 'A' ? 'bg-accent-blue' : 
                          mob['ãƒ©ãƒ³ã‚¯'] === 'FATE' ? 'bg-purple-600' : 'bg-gray-500';

        const lastKillDisplay = mob.lastKillTime ? formatTimeToJST(mob.lastKillTime.toISOString()) : 'æœªå ±å‘Š';
        const progressWidth = \`${mob.progress}%\`;
        
        const popConditions = [
            mob['POPæ¡ä»¶'],
            mob['æ™‚é–“æ¡ä»¶'] ? `ETæ™‚é–“: ${mob['æ™‚é–“æ¡ä»¶']}` : null,
            mob['å¤©å€™æ¡ä»¶'] ? `å¤©å€™: ${mob['å¤©å€™æ¡ä»¶']}` : null
        ].filter(Boolean).join(' / ');
        
        const mapFileName = mob['ãƒãƒƒãƒ—ç”»åƒ (ãƒ•ã‚¡ã‚¤ãƒ«å)'] || 'placeholder.webp';
        
        return `
            <div class="mob-card bg-secondary-dark rounded-xl shadow-lg border border-primary-dark cursor-pointer transform hover:scale-[1.01] transition duration-150" 
                 data-mob='${JSON.stringify(mob)}'>

                <!-- ä¸Šéƒ¨2è¡Œã®ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹èƒŒæ™¯ -->
                <div class="progress-background rounded-t-xl">
                    <!-- é€²æ—ãƒãƒ¼ (ãƒ‘ã‚¹ãƒ†ãƒ«ã‚«ãƒ©ãƒ¼ã®ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³) -->
                    <div class="progress-bar" style="width: ${progressWidth};"></div>
                    <div class="progress-content p-4 space-y-2 text-white">
                        
                        <!-- 1è¡Œç›®: ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼å ã‚¨ãƒªã‚¢å å ±å‘Šãƒœã‚¿ãƒ³ -->
                        <div class="flex justify-between items-start">
                            <div class="flex-grow">
                                <span class="${rankClass} text-white font-bold px-2 py-0.5 rounded-full text-xs mr-2">${mob['ãƒ©ãƒ³ã‚¯']}</span>
                                <span class="text-lg font-bold text-outline">${mob['ãƒ¢ãƒ–å']}</span>
                                ${mob.hasMap ? '<span class="ml-1 map-icon text-base" title="POPåœ°ç‚¹ã‚ã‚Š">ğŸ—ºï¸</span>' : ''}
                                <div class="text-sm font-medium text-gray-300">${mob['ã‚¨ãƒªã‚¢å']}</div>
                            </div>
                            <div class="report-button-wrapper flex-shrink-0">
                                <button class="report-button bg-red-600 hover:bg-red-700 text-white text-xs font-bold py-1 px-3 rounded-full transition-colors">
                                    å ±å‘Š
                                </button>
                            </div>
                        </div>

                        <!-- 2è¡Œç›®: æ¬¡å›POPæ™‚é–“ (çµŒé%) -->
                        <div class="text-sm font-semibold">
                            æ¬¡å›POPæ™‚é–“: <span class="${mob.popTimeClass} text-base font-bold">${mob.popTimeDisplay}</span> 
                            (çµŒé: ${mob.progress}%)
                        </div>
                    </div>
                </div>

                <!-- ä¸‹éƒ¨3è¡Œã®è©³ç´°ã‚¨ãƒªã‚¢ (ã‚¹ãƒ©ã‚¤ãƒ‰ãƒ€ã‚¦ãƒ³) -->
                <div class="details-slide bg-primary-dark/80 p-4 rounded-b-xl border-t border-secondary-dark">
                    <!-- è©³ç´°å†…å®¹ -->
                    <div class="text-sm space-y-3">
                        <p><span class="font-bold text-gray-300">å‰å›ã®è¨ä¼æ™‚é–“ (JST):</span> ${lastKillDisplay}</p>
                        <p><span class="font-bold text-gray-300">POPã•ã›ã‚‹æ¡ä»¶ã®èª¬æ˜:</span> ${popConditions || 'ãªã—'}</p>
                        
                        <!-- åº§æ¨™è¨˜éŒ²ç”¨ã®MAP -->
                        <div class="pt-4">
                            <h4 class="font-bold text-lg mb-2 text-gray-200">åº§æ¨™è¨˜éŒ²ç”¨ã®MAP</h4>
                            <div class="map-container" data-mob-name="${mob['ãƒ¢ãƒ–å']}">
                                <!-- âš ï¸ ãƒ‘ã‚¹ã‚’ "./Picture/" ã«ä¿®æ­£ã—ã¾ã—ãŸ âš ï¸ -->
                                <img src="./Picture/${mapFileName}" alt="${mob['ã‚¨ãƒªã‚¢å']} ãƒãƒƒãƒ—" 
                                     width="500" height="500"
                                     onerror="this.onerror=null; this.src='https://placehold.co/500x500/334155/ffffff?text=Map+Unavailable';"
                                     loading="lazy">
                                <!-- POP Points will be drawn here -->
                            </div>
                            <p class="text-xs text-gray-400 mt-2 text-center">
                                <span class="text-red-500 font-bold">èµ¤ä¸¸</span>: POPéå€™è£œåœ° / 
                                <span class="text-green-500 font-bold">ç·‘ä¸¸</span>: POPå€™è£œåœ°
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    // ==============================================================================
    // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã¨åˆæœŸåŒ–
    // ==============================================================================
    
    function setupFilters() {
        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                const newRank = button.getAttribute('data-rank');
                currentFilterRank = newRank;
                
                tabButtons.forEach(btn => btn.classList.remove('bg-accent-blue', 'text-white'));
                button.classList.add('bg-accent-blue', 'text-white');
                
                displayMobList();
            });
        });

        document.querySelector('.tab-button[data-rank="all"]').classList.add('bg-accent-blue', 'text-white');
    }

    // åˆæœŸåŒ–é–¢æ•°
    async function initApp() {
        try {
            document.getElementById('loading-indicator').textContent = "ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...";
            await fetchAllData();
            displayMobList();
            document.getElementById('loading-indicator').classList.add('hidden');
        } catch (e) {
            console.error("ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸã€‚", e);
            document.getElementById('loading-indicator').textContent = "ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚GASã®URLã¨ãƒ‡ãƒ—ãƒ­ã‚¤çŠ¶æ…‹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚";
        }
    }

    // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã«ãƒ‡ãƒ¼ã‚¿è¡¨ç¤ºã‚’é–‹å§‹
    document.addEventListener('DOMContentLoaded', () => {
        setupFilters();
        initApp();
        // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°ï¼ˆ5ç§’ã”ã¨ï¼‰
        setInterval(initApp, 5000); 
    });

    </script>
</body>
</html>
