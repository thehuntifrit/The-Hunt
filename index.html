<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Hunt</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* åŸºæœ¬çš„ãªãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰è¨­å®š */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a202c; /* ãƒ€ãƒ¼ã‚¯ãƒ–ãƒ«ãƒ¼ */
            color: #ffffff; /* ç™½æ–‡å­— */
        }
        
        /* ã‚³ãƒ³ãƒ†ãƒ³ãƒ„å¹…ã®åˆ¶å¾¡ã¨ã‚»ãƒ³ã‚¿ãƒªãƒ³ã‚° */
        .container {
            max-width: 1536px; /* 2XLç›¸å½“ */
            margin-left: auto;
            margin-right: auto;
            padding: 0 1rem;
        }

        /* ã‚«ã‚¹ã‚¿ãƒ ã‚°ãƒªãƒƒãƒ‰ï¼ˆãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œï¼‰ */
        .mob-grid {
            /* ã‚¹ãƒãƒ› (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ) */
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
        }
        /* PC (lgä»¥ä¸Š) - 512pxå¹…ã®ã‚«ãƒ¼ãƒ‰ã‚’3ã‚«ãƒ©ãƒ ã§é…ç½® */
        @media (min-width: 1024px) {
            .mob-grid {
                /* 512px (ã‚«ãƒ¼ãƒ‰å¹…) * 3 + gap */
                grid-template-columns: repeat(3, 1fr);
            }
        }
        /* ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆ (mdä»¥ä¸Š) - 1ã‚«ãƒ©ãƒ å¹…512pxã‚’ä¸­å¤®å¯„ã› */
        @media (min-width: 768px) and (max-width: 1023px) {
            .mob-grid {
                grid-template-columns: 1fr;
            }
            .mob-grid > div {
                max-width: 512px;
                margin-left: auto;
                margin-right: auto;
            }
        }

        /* ãƒ¢ãƒ–ã‚«ãƒ¼ãƒ‰ã®åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ« */
        .mob-card {
            background-color: #2d3748; /* ã‚«ãƒ¼ãƒ‰èƒŒæ™¯è‰² (æ¿ƒã„ã‚°ãƒ¬ãƒ¼) */
            border-radius: 0.5rem;
            /* FIX: ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³å±•é–‹ã«æˆ»ã—ã€è©³ç´°ãƒ‘ãƒãƒ«ãŒã‚«ãƒ¼ãƒ‰ã®å¤–ã«æ¼ã‚Œãªã„ã‚ˆã†ã«overflow: hiddenã‚’å†é©ç”¨ */
            overflow: hidden; 
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: box-shadow 0.2s, transform 0.2s;
            cursor: pointer;
            position: relative; 
            z-index: 10; 
        }

        .mob-card:hover {
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.2);
            transform: translateY(-2px);
        }

        /* çµŒéæ™‚é–“ã‚²ãƒ¼ã‚¸ã®ãƒ™ãƒ¼ã‚¹ */
        .progress-bar {
            height: 100%;
            background-color: #f6e05e; /* ãƒ‘ã‚¹ãƒ†ãƒ«ã‚¤ã‚¨ãƒ­ãƒ¼ã‚°ãƒªãƒ¼ãƒ³ */
            transition: width 0.5s ease-out;
        }

        /* ãƒ†ã‚­ã‚¹ãƒˆã®ã‚¢ã‚¦ãƒˆãƒ©ã‚¤ãƒ³é¢¨ã‚·ãƒ£ãƒ‰ã‚¦ (è—è‰² #3182ce) */
        .text-outline {
            text-shadow: 
                -1px -1px 0 #3182ce,  
                 1px -1px 0 #3182ce,
                -1px  1px 0 #3182ce,
                 1px  1px 0 #3182ce;
        }

        /* ã‚¿ãƒ–ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¹ã‚¿ã‚¤ãƒ« */
        .tab-active {
            background-color: #68d391 !important; /* ãƒ‘ã‚¹ãƒ†ãƒ«é»„ç·‘ */
            color: #1a202c !important; /* æ¿ƒã„æ–‡å­—è‰² */
            font-weight: 700;
        }

        /* ãƒãƒƒãƒ—ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
        .map-container {
            position: relative;
            max-width: 500px; /* ãƒãƒƒãƒ—ç”»åƒã®å›ºå®šå¹… */
            height: 500px; /* ãƒãƒƒãƒ—ç”»åƒã®å›ºå®šé«˜ã• */
            margin: 0 auto;
        }
        
        .map-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            user-select: none;
        }

        /* POPåœ°ç‚¹ãƒãƒ¼ã‚«ãƒ¼ */
        .pop-point {
            position: absolute;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            border: 2px solid #ffffff;
            cursor: pointer;
            opacity: 0.85;
            transition: transform 0.1s;
        }
        .pop-point:hover {
            transform: scale(1.3);
            opacity: 1;
        }

        /* çŠ¶æ…‹åˆ¥ã‚«ãƒ©ãƒ¼ */
        /* POPå€™è£œåœ° (ç·‘) */
        .pop-candidate {
            background-color: #48bb78; /* Tailwind green-500 */
        }
        /* ãƒã‚§ãƒƒã‚¯æ¸ˆã¿ (POPã—ãªã‹ã£ãŸã€èµ¤) */
        .pop-checked {
            background-color: #e53e3e; /* Tailwind red-600 */
        }

        /* ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹æƒ…å ± */
        #maintenance-message {
            color: #fc8181; /* èµ¤æ–‡å­— */
            font-weight: 700;
            padding: 0.5rem;
            margin-top: 0.5rem;
            text-align: center;
        }

        /* FIX: ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³å±•é–‹ã«æˆ»ã—ã€æ­£ç¢ºãªé«˜ã•è¨ˆæ¸¬ã§æ»‘ã‚‰ã‹ã«ã‚¹ãƒ©ã‚¤ãƒ‰ */
        .detail-content {
            /* ã‚¹ãƒ ãƒ¼ã‚ºãªã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
            transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1), 
                        opacity 0.4s ease-in-out, 
                        padding-top 0.4s cubic-bezier(0.4, 0, 0.2, 1), 
                        padding-bottom 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            
            /* éè¡¨ç¤ºçŠ¶æ…‹ */
            opacity: 0;
            max-height: 0;
            padding-top: 0;
            padding-bottom: 0;
            overflow: hidden;
            display: none; 
        }
    </style>
</head>
<body>
    
    <!-- FIXED HEADER START: ã‚¿ã‚¤ãƒˆãƒ«ã€èª¬æ˜ã€ã‚¿ãƒ–ã‚’å›ºå®š -->
    <div id="fixed-header" class="fixed top-0 left-0 right-0 z-20 bg-[#1a202c] shadow-2xl pb-4">
        <div class="container">
            <!-- ã‚µã‚¤ãƒˆã‚¿ã‚¤ãƒˆãƒ«ã¨èª¬æ˜ -->
            <header class="text-center pt-8 mb-4">
                <h1 class="text-5xl font-extrabold mb-2 text-yellow-400">The Hunt</h1>
                <p id="site-description" class="text-gray-300">
                    ã‚¨ã‚ªãƒ«ã‚¼ã‚¢ã®ãƒ¢ãƒ–ãƒãƒ³ãƒˆæƒ…å ±ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§è¿½è·¡ã—ã€POPåœ°ç‚¹ã‚’å…±æœ‰ã™ã‚‹ãŸã‚ã®ãƒ„ãƒ¼ãƒ«ã§ã™ã€‚
                    <br>
                    <span class="text-sm text-yellow-400">ç¾åœ¨ã€Ifritãƒ¯ãƒ¼ãƒ«ãƒ‰å°‚ç”¨ã§é‹ç”¨ä¸­ã€‚</span>
                </p>
                <!-- ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹æƒ…å ±è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
                <p id="maintenance-message" class="hidden"></p>
            </header>
            
            <!-- èª­ã¿è¾¼ã¿ä¸­/ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
            <div id="loading-status" class="text-center text-xl p-2 rounded-lg bg-yellow-900/50 mx-4">
                ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­ã§ã™...
            </div>

            <!-- ã‚¿ãƒ–ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ (grid-cols-4ã§ã‚µã‚¤ã‚ºçµ±ä¸€) -->
            <div id="filter-tabs" class="grid grid-cols-4 gap-2 mt-4 mx-4 p-1 bg-gray-700 rounded-lg">
                <!-- ã‚¿ãƒ–ã¯JavaScriptã§ç”Ÿæˆã•ã‚Œã¾ã™ -->
            </div>
        </div>
    </div>
    <!-- FIXED HEADER END -->

    <!-- ã‚³ãƒ³ãƒ†ãƒ³ãƒ„æœ¬ä½“ (ãƒ˜ãƒƒãƒ€ãƒ¼ã®é«˜ã•åˆ†ã€ä¸Šéƒ¨ã«ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’ç¢ºä¿) -->
    <!-- ãƒšãƒ¼ã‚¸æœ€ä¸‹éƒ¨ã« pb-40 (10rem) ã®ä½™ç™½ã‚’è¿½åŠ  -->
    <div class="container pt-[250px] lg:pt-[220px] pb-40">
        <!-- ãƒ¢ãƒ–ä¸€è¦§ã‚³ãƒ³ãƒ†ãƒŠ -->
        <div id="mob-list-container" class="mob-grid">
            <!-- ãƒ¢ãƒ–ã‚«ãƒ¼ãƒ‰ã¯JavaScriptã§ã“ã“ã«æŒ¿å…¥ã•ã‚Œã¾ã™ -->
        </div>
    </div>

    <!-- è¨ä¼å ±å‘Šãƒ¢ãƒ¼ãƒ€ãƒ« (æ—¥æ™‚å…¥åŠ›) -->
    <div id="report-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-50">
        <div class="bg-gray-800 p-6 rounded-xl w-11/12 max-w-sm">
            <h2 id="modal-title" class="text-2xl font-bold mb-4 text-white">è¨ä¼å ±å‘Š</h2>
            <p class="text-gray-300 mb-4">è¨ä¼æ—¥æ™‚ã‚’æ­£ç¢ºã«å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ç¾åœ¨ã®JSTãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã™ã€‚</p>
            
            <input type="hidden" id="report-mob-name">
            <input type="hidden" id="report-mob-rank">
            <input type="hidden" id="report-mob-area">

            <!-- æ—¥æ™‚å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ -->
            <label for="kill-time-input" class="block text-sm font-medium text-gray-400 mb-1">è¨ä¼æ—¥æ™‚ (JST)</label>
            <input type="datetime-local" id="kill-time-input" 
                   class="w-full p-2 mb-4 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-green-500 focus:border-green-500">

            <!-- å ±å‘Šè€…UUIDè¡¨ç¤º -->
            <div id="reporter-uuid-display" class="text-xs text-right text-gray-500 mb-4"></div>

            <div id="report-status" class="text-center text-sm mb-4"></div>

            <div class="flex justify-end space-x-3">
                <button onclick="closeModal()" class="px-4 py-2 bg-gray-600 hover:bg-gray-500 text-white font-semibold rounded-lg transition duration-150">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button onclick="submitKillReport()" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white font-semibold rounded-lg transition duration-150">å ±å‘Šç¢ºå®š</button>
            </div>
        </div>
    </div>

    <script>
        // ğŸš¨ è¨­å®šé …ç›®: GAS API URL
        const GAS_API_URL = 'https://script.google.com/macros/s/AKfycbxyutpOIZYI9Ce51s4vawk6S460QgM4wYcaLFJKUBi00_LKhNXT9-6N0n178KdoXkP7wg/exec'; 
        const STATIC_DATA_URL = './mob_data.json'; 

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«ãªãƒ‡ãƒ¼ã‚¿ã‚¹ãƒˆã‚¢
        let globalMobConfig = {};      
        let globalLocationDef = {};    
        let globalHuntList = [];       
        let globalLocationState = [];  
        let currentFilter = 'ALL';
        let reporterUUID = '';
        
        // ç¾åœ¨é–‹ã„ã¦ã„ã‚‹è©³ç´°ãƒ‘ãƒãƒ«ã®IDã‚’è¿½è·¡ã™ã‚‹ãŸã‚ã®å¤‰æ•°
        let openMobNameId = null; // FIX: ãƒ¢ãƒ–IDã‚’æ­£ã—ãè¿½è·¡ã™ã‚‹

        // ãƒªãƒãƒƒãƒ—é–“éš”ï¼ˆç§’ï¼‰ã‚’ãƒ©ãƒ³ã‚¯ã«å¿œã˜ã¦è¨­å®š
        const DEFAULT_INTERVALS = {
            'S': 27000, 
            'A': 300 
        };

        // UIè¦ç´ 
        const mobListContainer = document.getElementById('mob-list-container');
        const loadingStatus = document.getElementById('loading-status');
        const filterTabsContainer = document.getElementById('filter-tabs');
        const maintenanceMessage = document.getElementById('maintenance-message');


        // ====================================================================
        // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
        // ====================================================================

        /**
         * åŒ¿åãƒ¬ãƒãƒ¼ãƒˆç”¨UUIDã‚’å–å¾—ãƒ»ç”Ÿæˆã—ã¾ã™ã€‚
         */
        function getReporterUUID() {
            let uuid = localStorage.getItem('reporterUUID');
            if (!uuid) {
                uuid = crypto.randomUUID();
                localStorage.setItem('reporterUUID', uuid);
            }
            return uuid;
        }

        /**
         * UNIXã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’JSTã®æ–‡å­—åˆ—ã«ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã—ã¾ã™ã€‚
         */
        function formatTimeToJST(timestamp) {
            if (!timestamp) return 'ä¸æ˜';
            const date = new Date(timestamp);
            return date.toLocaleTimeString('ja-JP', {
                timeZone: 'Asia/Tokyo',
                year: 'numeric',
                month: 'numeric',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        }
        
        /**
         * Dateã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ <input type="datetime-local"> å½¢å¼ (YYYY-MM-DDThh:mm) ã«å¤‰æ›ã—ã¾ã™ã€‚ï¼ˆJSTã¨ã—ã¦å‡¦ç†ï¼‰
         */
        function dateToDateTimeLocal(date) {
            const offset = date.getTimezoneOffset() * 60000;
            const jstOffset = 9 * 60 * 60000;
            
            const jstDate = new Date(date.getTime() + offset + jstOffset);

            const pad = (num) => num.toString().padStart(2, '0');
            
            const year = jstDate.getFullYear();
            const month = pad(jstDate.getMonth() + 1);
            const day = pad(jstDate.getDate());
            const hours = pad(jstDate.getHours());
            const minutes = pad(jstDate.getMinutes());
            
            return `${year}-${month}-${day}T${hours}:${minutes}`;
        }


        /**
         * ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒªãƒ†ãƒ©ãƒ«å†…ã®XSSå¯¾ç­–
         */
        function safeHTML(str) {
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        /**
         * HTML IDã¨ã—ã¦å®‰å…¨ãªæ–‡å­—åˆ—ã‚’ç”Ÿæˆã—ã¾ã™ã€‚
         */
        function safeId(str) {
            if (!str) return 'id-' + crypto.randomUUID();
            // ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼åã‹ã‚‰å®‰å…¨ãªIDã‚’ç”Ÿæˆ
            return String(str).replace(/\s/g, '_').replace(/[^a-zA-Z0-9_-]/g, '');
        }


        // ====================================================================
        // ãƒ‡ãƒ¼ã‚¿å–å¾— (é™çš„/å‹•çš„)
        // ====================================================================

        /**
         * é™çš„ãªãƒ¢ãƒ–è¨­å®šãƒ‡ãƒ¼ã‚¿ (mob_data.json) ã‚’å–å¾—ã—ã¾ã™ã€‚
         */
        async function fetchStaticData() {
            try {
                const response = await fetch(STATIC_DATA_URL);
                if (!response.ok) {
                    throw new Error(`Failed to fetch static data: ${response.statusText}`);
                }
                const data = await response.json();
                
                globalMobConfig = data.mobConfig || {};
                globalLocationDef = data.locationDef || {};
                
                loadingStatus.textContent = 'é™çš„ãƒ‡ãƒ¼ã‚¿ã‚’æ­£å¸¸ã«èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ä¸­ã§ã™...';
                
                generateTabs(); 

            } catch (error) {
                console.error("Error fetching static data:", error);
                loadingStatus.innerHTML = `
                    <div class="text-red-400">ğŸš¨ è‡´å‘½çš„ãªã‚¨ãƒ©ãƒ¼: ãƒ¢ãƒ–è¨­å®šãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</div>
                    <div class="text-sm mt-2 text-gray-400">
                        mob_data.jsonãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã—ãªã„ã‹ã€JSONã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚
                    </div>
                `;
                throw error;
            }
        }

        /**
         * Google Apps Script (GAS) API ã‹ã‚‰å‹•çš„ãªãƒ‡ãƒ¼ã‚¿ (ãƒ­ã‚°ã€çŠ¶æ…‹) ã‚’å–å¾—ã—ã¾ã™ã€‚
         */
        async function fetchDynamicData() {
            console.log(`[Fetch] Fetching dynamic data from: ${GAS_API_URL}?mode=getdata`);

            try {
                const response = await fetch(`${GAS_API_URL}?mode=getdata`, {
                    method: 'GET',
                    cache: 'no-cache' 
                });

                if (!response.ok) {
                    throw new Error(`GAS API HTTP Error: ${response.status} ${response.statusText}`);
                }

                const result = await response.json();

                if (result.status === 'success') {
                    globalHuntList = result.huntList || [];
                    globalLocationState = result.locationState || [];
                    
                    checkMaintenance(result.maintenance);

                    renderMobList();

                    loadingStatus.classList.add('hidden'); 
                } else {
                    throw new Error(`GAS API Error: ${result.message}`);
                }

            } catch (error) {
                console.error("Error fetching dynamic data from GAS:", error);
                loadingStatus.classList.remove('hidden');
                loadingStatus.innerHTML = `<div class="text-red-400">ğŸš¨ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼: ${error.message}</div>`;
            }
        }

        /**
         * ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹æƒ…å ±ã‚’ãƒã‚§ãƒƒã‚¯ã—ã€è¡¨ç¤ºã—ã¾ã™ã€‚
         */
        function checkMaintenance(message) {
            maintenanceMessage.textContent = '';
            maintenanceMessage.classList.add('hidden');
            
            if (message && message.toLowerCase().includes('maintenance')) {
                maintenanceMessage.textContent = 'ğŸš¨ ã‚µãƒ¼ãƒãƒ¼ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹æƒ…å ±: ' + message;
                maintenanceMessage.classList.remove('hidden');
            }
        }

        // ====================================================================
        // UIæç”»é–¢æ•°
        // ====================================================================

        /**
         * ã‚¿ãƒ–ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’ç”Ÿæˆã—ã¾ã™ã€‚
         */
        function generateTabs() {
            const ranks = ['ALL', 'S', 'A', 'FATE'];
            filterTabsContainer.innerHTML = ranks.map(rank => `
                <button 
                    onclick="setFilter('${rank}')" 
                    class="tab-button w-full px-4 py-2 text-sm font-semibold rounded-lg bg-gray-600 hover:bg-gray-500 text-white transition duration-150 ${rank === currentFilter ? 'tab-active' : ''}"
                    data-filter="${rank}"
                >
                    ${rank}
                </button>
            `).join('');
        }

        /**
         * ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’è¨­å®šã—ã€ãƒªã‚¹ãƒˆã‚’å†æç”»ã—ã¾ã™ã€‚
         * @param {string} filter - ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ–‡å­—åˆ— (ALL, S, A, FATE)
         */
        function setFilter(filter) {
            currentFilter = filter;
            renderMobList();
            
            // ãƒ•ã‚£ãƒ«ã‚¿ãƒœã‚¿ãƒ³ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’æ›´æ–°
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('tab-active');
                if (button.dataset.filter === filter) {
                    button.classList.add('tab-active');
                }
            });
        }


        /**
         * ãƒ¢ãƒ–ãƒªã‚¹ãƒˆå…¨ä½“ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã—ã¾ã™ã€‚
         */
        function renderMobList() {
            const allMobs = Object.keys(globalMobConfig).map(key => {
                const mob = globalMobConfig[key];
                return {
                    ...mob,
                    mobName: mob['ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼å'] || key || 'ä¸æ˜ãªãƒ¢ãƒ–',
                    rank: mob['ãƒ©ãƒ³ã‚¯'] || 'N/A',
                    area: mob['ã‚¨ãƒªã‚¢å'] || 'ã‚¨ãƒªã‚¢ä¸æ˜',
                    popCondition: mob['POPæ¡ä»¶'] || 'ãªã—',
                    interval: mob['ãƒªãƒãƒƒãƒ—é–“éš” (ç§’)'] || DEFAULT_INTERVALS[mob['ãƒ©ãƒ³ã‚¯']] || 1800,
                    mapFilename: mob['ãƒãƒƒãƒ—ç”»åƒ (ãƒ•ã‚¡ã‚¤ãƒ«å)']
                };
            });

            // FATEãƒ©ãƒ³ã‚¯ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚° ('FATE'ã¾ãŸã¯'F')
            let filteredMobs = allMobs.filter(mob => {
                const mobRank = mob.rank || 'N/A';
                if (currentFilter === 'ALL') return true;
                if (currentFilter === 'FATE') return mobRank === 'FATE' || mobRank === 'F'; 
                return mobRank === currentFilter;
            });
            
            // è¨ä¼æ™‚é–“ã¨ãƒªãƒãƒƒãƒ—ç‡ã®è¨ˆç®—ã€ã‚½ãƒ¼ãƒˆ
            filteredMobs = filteredMobs
                .map(mob => calculateMobTime(mob)) 
                .sort((a, b) => b.progressPercent - a.progressPercent); 

            if (filteredMobs.length === 0) {
                mobListContainer.innerHTML = `<p class="text-center text-gray-400 col-span-full">é¸æŠã•ã‚ŒãŸãƒ©ãƒ³ã‚¯ã®ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ã¯ã„ã¾ã›ã‚“ã€‚</p>`;
                return;
            }

            // æ–°ã—ã„ãƒªã‚¹ãƒˆã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
            mobListContainer.innerHTML = filteredMobs.map(mob => createMobCard(mob)).join('');

            // è©³ç´°è¡¨ç¤ºã®çŠ¶æ…‹ã‚’ä¿æŒ (å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°æ™‚ã«é–‹ã„ã¦ã„ãŸãƒ‘ãƒãƒ«ã‚’å¾©å…ƒ)
            if (openMobNameId) {
                const mobToRender = filteredMobs.find(m => safeId(m.mobName) === openMobNameId);
                const detailElement = document.getElementById(`detail-${openMobNameId}`);
                
                if (detailElement) {
                    // FIX: å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°æ™‚ã¯å³åº§ã«ã‚³ãƒ³ãƒ†ãƒ³ãƒ„é«˜ã•ã‚’è¨ˆç®—ã—ã¦å±•é–‹ã™ã‚‹
                    detailElement.style.display = 'block';
                    
                    // æ­£ã—ã„é«˜ã•ã‚’è¨ˆæ¸¬
                    const scrollHeight = detailElement.scrollHeight;

                    detailElement.style.maxHeight = `${scrollHeight + 24}px`; // ç¸¦ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°åˆ†ã‚’è€ƒæ…®ã—ã¦èª¿æ•´
                    detailElement.style.opacity = '1';
                    detailElement.style.paddingTop = '0.5rem'; 
                    detailElement.style.paddingBottom = '1rem'; 
                    
                    // ãƒãƒƒãƒ—å†æç”»
                    if (mobToRender) {
                        renderMap(mobToRender.mobName, mobToRender.area);
                    }
                } else {
                    // é–‹ã„ã¦ã„ãŸãƒ¢ãƒ–ãŒãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã§éè¡¨ç¤ºã«ãªã£ãŸå ´åˆã€çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
                    openMobNameId = null;
                }
            }
        }

        /**
         * å€‹åˆ¥ã®ãƒ¢ãƒ–ã‚«ãƒ¼ãƒ‰ã®HTMLã‚’ç”Ÿæˆã—ã¾ã™ã€‚
         */
        function createMobCard(mob) {
            const mobName = mob.mobName;
            // MobNameã‚’å…ƒã«ã—ãŸIDã‚’ä½¿ç”¨
            const safeMobNameId = safeId(mobName); 
            
            if (mobName === 'ä¸æ˜ãªãƒ¢ãƒ–') {
                console.warn("Skipping card due to missing mob name:", mob);
                return ''; 
            }

            const lastKillTime = mob.lastKillTime;
            const progressPercent = mob.progressPercent;
            const nextPopTime = mob.nextPopTime;

            const rawMapImageFilename = mob.mapFilename || '';
            const hasMap = rawMapImageFilename !== '';
            
            const mapIcon = hasMap ? 'ğŸ—ºï¸' : '';
            
            const cardClasses = `mob-card p-0 transition duration-300`;
            const progressColor = progressPercent > 90 ? 'bg-red-500' : '#68d391'; /* 90%ä»¥ä¸Šã¯èµ¤ */

            // ãƒ©ãƒ³ã‚¯åˆ¥ã‚«ãƒ©ãƒ¼è¨­å®š
            let rankColor = 'bg-gray-600'; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
            const mobRank = mob.rank || 'N/A';

            if (mobRank === 'S') {
                rankColor = 'bg-orange-500'; // S: ã‚ªãƒ¬ãƒ³ã‚¸
            } else if (mobRank === 'A') {
                rankColor = 'bg-green-600'; // A: ç·‘
            } else if (mobRank === 'FATE' || mobRank === 'F') {
                rankColor = 'bg-blue-400'; // FATE: é’
            } 
            
            // POPæ¡ä»¶ã®æ”¹è¡Œå‡¦ç† (ã€Œ//ã€ã‚’<br>ã«å¤‰æ›ã—ã¦è¡¨ç¤º)
            const formattedPopCondition = safeHTML(mob.popCondition || 'ãªã—').replace(/\/\//g, '<br>');


            return `
                <div class="${cardClasses}" onclick="toggleMobDetail('${safeMobNameId}', '${safeHTML(mob.area)}')" data-mob-name="${safeHTML(mobName)}">
                    
                    <!-- 1è¡Œç›®ã¨2è¡Œç›® (ã‚²ãƒ¼ã‚¸èƒŒæ™¯) -->
                    <div class="relative overflow-hidden z-10">
                        <!-- çµŒéæ™‚é–“ã‚²ãƒ¼ã‚¸ -->
                        <div class="progress-bar absolute top-0 left-0 h-full z-0" style="width: ${progressPercent}%; background-color: ${progressColor};"></div>
                        
                        <!-- ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãƒ¬ã‚¤ãƒ¤ãƒ¼ -->
                        <div class="relative z-10 p-4">
                            <div class="flex justify-between items-start mb-1">
                                
                                <!-- ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼åã¨ãƒ©ãƒ³ã‚¯ã€ã‚¨ãƒªã‚¢åã®è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
                                <div class="flex flex-col">
                                    
                                    <!-- 1è¡Œç›®: ãƒ©ãƒ³ã‚¯ã¨ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼å -->
                                    <div class="flex items-baseline space-x-2 mb-0.5">
                                        <!-- ãƒ©ãƒ³ã‚¯ãƒãƒƒã‚¸: rounded-lgã«å¤‰æ›´ã—ã€paddingã‚’èª¿æ•´ -->
                                        <span class="px-2 py-0.5 text-sm font-bold rounded-lg ${rankColor} text-white flex-shrink-0">${safeHTML(mob.rank || 'N/A')}</span>
                                        
                                        <!-- ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼å (ã‚µã‚¤ã‚ºã‚’text-lgã«ç¸®å°) -->
                                        <span class="text-lg font-bold text-white text-outline">${safeHTML(mobName)} ${mapIcon}</span>
                                    </div>
                                    
                                    <!-- 2è¡Œç›®: ã‚¨ãƒªã‚¢å (ä½ç½®ã‚’2.2remã«ã€æ–‡å­—ã‚µã‚¤ã‚ºã‚’text-xsã«ä¿®æ­£) -->
                                    <span class="text-xs text-gray-300" style="margin-left: 2.2rem;">${safeHTML(mob.area || 'ã‚¨ãƒªã‚¢ä¸æ˜')}</span>
                                </div>
                                
                                <!-- å ±å‘Šãƒœã‚¿ãƒ³ (ã‚¯ãƒªãƒƒã‚¯ãŒè©³ç´°ãƒˆã‚°ãƒ«ã«ä¼æ’­ã—ãªã„ã‚ˆã† event.stopPropagation() ã‚’ä½¿ç”¨) -->
                                <button 
                                    class="mt-1 px-2 py-1 bg-red-700 hover:bg-red-600 text-xs text-white font-bold rounded-full transition duration-150 flex-shrink-0"
                                    onclick="event.stopPropagation(); openModal('${safeHTML(mobName)}', '${safeHTML(mob.rank || 'N/A')}', '${safeHTML(mob.area || 'ã‚¨ãƒªã‚¢ä¸æ˜')}')"
                                >
                                    å ±å‘Š
                                </button>
                            </div>
                            
                            <!-- æ¬¡å›POPæ™‚é–“ (çµŒé%) -->
                            <div class="text-sm font-semibold mt-2">
                                <span class="text-white">æ¬¡å›POP: ${nextPopTime} (${progressPercent.toFixed(1)}%)</span>
                            </div>
                        </div>
                    </div>

                    <!-- è©³ç´°æƒ…å ± (ã‚¹ãƒ©ã‚¤ãƒ‰è¡¨ç¤ºéƒ¨åˆ†) - ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ã§å±•é–‹ã—ã€ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ä¸‹ã«æŠ¼ã—å‡ºã—ã¾ã™ -->
                    <div id="detail-${safeMobNameId}" class="detail-content bg-gray-700 text-gray-300 px-4">
                        <div class="text-xs border-t border-gray-600 pt-2">
                            <!-- å‰å›ã®è¨ä¼æ™‚é–“ -->
                            <p class="mb-1"><strong>å‰å›è¨ä¼:</strong> ${formatTimeToJST(lastKillTime)}</p>
                            
                            <!-- POPã•ã›ã‚‹æ¡ä»¶ã®èª¬æ˜ (formattedPopConditionã‚’ä½¿ç”¨) -->
                            <p class="mb-2"><strong>POPæ¡ä»¶:</strong> ${formattedPopCondition}</p>
                            
                            <!-- åº§æ¨™è¨˜éŒ²ç”¨ã®MAP -->
                            ${hasMap ? `
                                <div class="mt-4">
                                    <h4 class="text-md font-semibold text-white mb-2">POPå€™è£œåœ° (${safeHTML(mob.area || 'ã‚¨ãƒªã‚¢ä¸æ˜')})</h4>
                                    <div id="map-canvas-${safeMobNameId}" class="map-container rounded-lg overflow-hidden border border-gray-600">
                                        <!-- ãƒãƒƒãƒ—ã¨åº§æ¨™ç‚¹ã¯ã“ã“ã«æç”»ã•ã‚Œã¾ã™ -->
                                    </div>
                                </div>
                            ` : `<p class="mt-4">ã“ã®ãƒ¢ãƒ–ã®ãƒãƒƒãƒ—åº§æ¨™ãƒ‡ãƒ¼ã‚¿ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>`}
                        </div>
                    </div>
                </div>
            `;
        }
        
        /**
         * ãƒ¢ãƒ–ã®æœ€æ–°ã®è¨ä¼æ™‚é–“ã‹ã‚‰ãƒªãƒãƒƒãƒ—æ™‚é–“ã‚„é€²æ—ç‡ã‚’è¨ˆç®—ã—ã¾ã™ã€‚
         */
        function calculateMobTime(mob) {
            const mobName = mob.mobName;
            const mobRank = mob.rank;
            
            const defaultInterval = DEFAULT_INTERVALS[mobRank] || 1800; 
            const intervalSeconds = mob.interval || defaultInterval;

            const latestKill = globalHuntList
                .filter(log => log.mobName === mobName)
                .sort((a, b) => new Date(b.killTime) - new Date(a.killTime))[0];

            let lastKillTime = null;
            let timeSinceKill = 0;
            let progressPercent = 0;
            let nextPopTime = "è¨ä¼å ±å‘Šãªã—";

            if (latestKill) {
                lastKillTime = new Date(latestKill.killTime).getTime();
                const now = Date.now();
                
                timeSinceKill = Math.floor((now - lastKillTime) / 1000);
                
                progressPercent = Math.min((timeSinceKill / intervalSeconds) * 100, 100);

                const nextPopTimestamp = lastKillTime + (intervalSeconds * 1000);
                nextPopTime = formatTimeToJST(nextPopTimestamp);

                if (progressPercent >= 100) {
                    nextPopTime = "POPå¯èƒ½";
                }
            }

            return {
                ...mob,
                lastKillTime: lastKillTime,
                progressSeconds: timeSinceKill,
                progressPercent: progressPercent,
                nextPopTime: nextPopTime,
            };
        }


        /**
         * ãƒ¢ãƒ–ã‚«ãƒ¼ãƒ‰ã®è©³ç´°è¡¨ç¤ºã‚’ãƒˆã‚°ãƒ«ã—ã¾ã™ã€‚ï¼ˆæ»‘ã‚‰ã‹ã«é–‹é–‰ï¼‰
         * @param {string} mobId - ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼åã«åŸºã¥ãä¸€æ„ã®ID (safeId(mobName))
         * @param {string} area - ã‚¨ãƒªã‚¢å
         */
        function toggleMobDetail(mobId, area) {
            const detailElement = document.getElementById(`detail-${mobId}`);
            if (!detailElement) {
                console.error(`Detail element not found for ID: ${mobId}`);
                return;
            }

            const ANIMATION_DURATION_MS = 400; 
            const OPEN_PADDING_TOP = '0.5rem';
            const OPEN_PADDING_BOTTOM = '1rem';
            
            // ç¾åœ¨é–‹ã„ã¦ã„ã‚‹ã‹ã©ã†ã‹ã‚’ã€IDãƒˆãƒ©ãƒƒã‚«ãƒ¼ã‚’å…ƒã«åˆ¤å®š
            const isCurrentlyOpen = mobId === openMobNameId; 

            // 1. ä»–ã®è¦ç´ ãŒé–‹ã„ã¦ã„ã‚‹å ´åˆã€ãã‚Œã‚’é–‰ã˜ã‚‹ (å˜ä½“è¡¨ç¤ºã®ä¿è¨¼)
            if (openMobNameId && openMobNameId !== mobId) {
                const currentlyOpenEl = document.getElementById(`detail-${openMobNameId}`);
                if (currentlyOpenEl) {
                    currentlyOpenEl.style.maxHeight = '0';
                    currentlyOpenEl.style.opacity = '0';
                    currentlyOpenEl.style.paddingTop = '0';
                    currentlyOpenEl.style.paddingBottom = '0';
                    
                    // é–‰ã˜ã‚‹ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å¾Œã« display: none ã«æˆ»ã™
                    setTimeout(() => currentlyOpenEl.style.display = 'none', ANIMATION_DURATION_MS);
                }
            }
            
            // 2. é–‹é–‰å‡¦ç†
            if (isCurrentlyOpen) {
                // é–‰ã˜ã‚‹
                detailElement.style.maxHeight = '0';
                detailElement.style.opacity = '0';
                detailElement.style.paddingTop = '0';
                detailElement.style.paddingBottom = '0';
                
                // é–‰ã˜ã‚‹ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å¾Œã« display: none ã«æˆ»ã™
                setTimeout(() => detailElement.style.display = 'none', ANIMATION_DURATION_MS); 
                
                openMobNameId = null; // ãƒˆãƒ©ãƒƒã‚«ãƒ¼ã‚’ãƒªã‚»ãƒƒãƒˆ

            } else {
                // é–‹ã
                // FIX: é–‹ãå‰ã«ã€ä¸€æ™‚çš„ã«é«˜ã•ã‚’autoã«ã—ã¦scrollHeightã‚’è¨ˆæ¸¬ã™ã‚‹
                detailElement.style.display = 'block';
                detailElement.style.maxHeight = '0';
                detailElement.style.opacity = '0';
                
                // ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®é«˜ã•ï¼ˆãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ãªã—ã®ç´”ç²‹ãªé«˜ã•ï¼‰ã‚’å–å¾—
                const contentWrapper = detailElement.querySelector('div.pt-2'); 
                const contentHeight = contentWrapper ? contentWrapper.offsetHeight : 0; 

                // ç·Max Height = ã‚³ãƒ³ãƒ†ãƒ³ãƒ„é«˜ã• + ç¸¦ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°åˆè¨ˆ (0.5rem + 1rem = 1.5rem = 24px)
                const totalMaxHeight = contentHeight + 24; 

                // æ¬¡ã®æç”»ã‚µã‚¤ã‚¯ãƒ«ã§ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒˆãƒªã‚¬ãƒ¼
                requestAnimationFrame(() => {
                    detailElement.style.maxHeight = `${totalMaxHeight}px`; 
                    detailElement.style.opacity = '1';
                    detailElement.style.paddingTop = OPEN_PADDING_TOP;
                    detailElement.style.paddingBottom = OPEN_PADDING_BOTTOM;
                });
                
                openMobNameId = mobId; // ãƒˆãƒ©ãƒƒã‚«ãƒ¼ã‚’æ›´æ–°

                // ãƒãƒƒãƒ—ã®æç”»
                const mobToRender = Object.values(globalMobConfig).find(m => safeId(m['ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼å']) === mobId);
                if (mobToRender) {
                    renderMap(mobToRender.mobName, area);
                }
            }
        }


        // ====================================================================
        // ãƒãƒƒãƒ—ã¨åº§æ¨™ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°
        // ====================================================================
        
        /**
         * æŒ‡å®šã•ã‚ŒãŸãƒ¢ãƒ–ã®POPåœ°ç‚¹ã‚’ãƒãƒƒãƒ—ä¸Šã«æç”»ã—ã¾ã™ã€‚
         */
        function renderMap(mobName, area) {
            // ãƒãƒƒãƒ—ã‚³ãƒ³ãƒ†ãƒŠã¯ mobName ã‚’å…ƒã«ã—ãŸ ID ã‚’ä½¿ç”¨
            const safeNameId = safeId(mobName);
            const mapContainer = document.getElementById(`map-canvas-${safeNameId}`);
            
            if (!mapContainer) return;

            const mobConfig = Object.values(globalMobConfig).find(m => m['ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼å'] === mobName);
            const rawMapImageFilename = mobConfig?.['ãƒãƒƒãƒ—ç”»åƒ (ãƒ•ã‚¡ã‚¤ãƒ«å)'] || '';
            
            if (!rawMapImageFilename) {
                mapContainer.innerHTML = `<p class="text-center text-gray-500 py-4">ãƒãƒƒãƒ—ç”»åƒãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</p>`;
                return;
            }

            // æ—¢ã«ç”»åƒãŒè¨­å®šã•ã‚Œã¦ã„ã‚Œã°å†æç”»ã¯ãƒ‰ãƒƒãƒˆã®ã¿
            if (!mapContainer.querySelector('img')) {
                const mapImagePath = `./Picture/${rawMapImageFilename.replace(/\s/g, '_')}`;
                mapContainer.innerHTML = `<img src="${mapImagePath}" alt="${area} Map" class="absolute inset-0">`;
            }

            // åº§æ¨™ãƒ‡ãƒ¼ã‚¿å–å¾—
            const mobLocations = globalLocationDef[mobName] || [];
            
            // ç¾åœ¨ãƒã‚§ãƒƒã‚¯æ¸ˆã¿ã®åº§æ¨™IDãƒªã‚¹ãƒˆã‚’ä½œæˆ
            const checkedLocations = new Set(
                globalLocationState
                    .filter(state => state.mobName === mobName)
                    .map(state => state.checkedLocationId)
            );

            // æ—¢å­˜ã®ãƒ‰ãƒƒãƒˆã‚’ã‚¯ãƒªã‚¢ã—ã¦ã‹ã‚‰å†æç”»
            mapContainer.querySelectorAll('.pop-point').forEach(el => el.remove());

            mobLocations.forEach(loc => {
                const isChecked = checkedLocations.has(loc.locationId);
                
                const point = document.createElement('div');
                point.className = `pop-point transition duration-100 ${isChecked ? 'pop-checked' : 'pop-candidate'}`;
                point.title = `åº§æ¨™ID: ${loc.locationId} (${isChecked ? 'ãƒã‚§ãƒƒã‚¯æ¸ˆã¿' : 'å€™è£œ'})`;
                
                const xPercent = (loc.coordX / 500) * 100;
                const yPercent = (loc.coordY / 500) * 100;

                point.style.left = `calc(${xPercent}% - 7px)`;
                point.style.top = `calc(${yPercent}% - 7px)`;
                
                point.dataset.mobName = mobName;
                point.dataset.locationId = loc.locationId;
                
                point.onclick = (e) => {
                    e.stopPropagation();
                    handlePopPointClick(mobName, loc.locationId, point);
                };

                mapContainer.appendChild(point);
            });
        }
        
        /**
         * POPåœ°ç‚¹ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸã¨ãã®å‡¦ç†ï¼ˆãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³ï¼‰ã€‚
         */
        async function handlePopPointClick(mobName, locationId, pointElement) {
            if (pointElement.classList.contains('pop-checked')) {
                console.log(`Location ${locationId} already checked for ${mobName}`);
                return;
            }

            pointElement.classList.add('pop-checked');
            pointElement.classList.remove('pop-candidate');
            pointElement.title = `åº§æ¨™ID: ${locationId} (ãƒã‚§ãƒƒã‚¯æ¸ˆã¿)`;

            const payload = {
                type: 'location',
                mobName: mobName,
                locationId: locationId,
                reporterId: reporterUUID,
            };

            await sendPostRequest(payload, "POPåœ°ç‚¹ã®ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³ã‚’å ±å‘Šä¸­...");
            
            fetchDynamicData();
        }

        // ====================================================================
        // è¨ä¼å ±å‘Šãƒ¢ãƒ¼ãƒ€ãƒ«
        // ====================================================================

        /**
         * å ±å‘Šãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ãã¾ã™ã€‚
         */
        function openModal(mobName, mobRank, mobArea) {
            document.getElementById('modal-title').textContent = `${mobName} è¨ä¼å ±å‘Š`;
            document.getElementById('report-mob-name').value = mobName;
            document.getElementById('report-mob-rank').value = mobRank;
            document.getElementById('report-mob-area').value = mobArea;
            document.getElementById('report-status').textContent = '';
            
            // 1. ç¾åœ¨ã®JSTæ™‚åˆ»ã‚’ datetime-local ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã§å–å¾—ã—ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã«è¨­å®š
            const now = new Date();
            const nowJST = dateToDateTimeLocal(now);
            document.getElementById('kill-time-input').value = nowJST;

            // 2. å ±å‘Šè€…UUIDã‚’ãƒã‚¹ã‚¯ã—ã¦è¡¨ç¤º (æœ€åˆã®5æ¡ã‚’è¡¨ç¤º)
            const maskedUUID = reporterUUID.substring(0, 5) + '*****';
            document.getElementById('reporter-uuid-display').textContent = `å ±å‘Šè€…ID: ${maskedUUID}`;

            document.getElementById('report-modal').classList.remove('hidden');
        }

        /**
         * å ±å‘Šãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã¾ã™ã€‚
         */
        function closeModal() {
            document.getElementById('report-modal').classList.add('hidden');
        }

        /**
         * è¨ä¼å ±å‘Šã‚’GASã«é€ä¿¡ã—ã¾ã™ã€‚
         */
        async function submitKillReport() {
            const mobName = document.getElementById('report-mob-name').value;
            const mobRank = document.getElementById('report-mob-rank').value;
            const mobArea = document.getElementById('report-mob-area').value;
            const killTimeLocal = document.getElementById('kill-time-input').value; 
            const statusElement = document.getElementById('report-status');

            if (!killTimeLocal) {
                loadingStatus.textContent = 'ğŸš¨ è¨ä¼æ—¥æ™‚ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚';
                loadingStatus.classList.remove('hidden');
                setTimeout(() => loadingStatus.classList.add('hidden'), 3000);
                return;
            }

            const selectedDate = new Date(killTimeLocal);
            const killTimeISO = selectedDate.toISOString(); 

            const payload = {
                type: 'kill',
                mobName: mobName,
                mobRank: mobRank,
                area: mobArea,
                world: 'Ifrit', 
                killTime: killTimeISO, 
                reporterId: reporterUUID,
            };
            
            closeModal(); 

            const result = await sendPostRequest(payload, `${mobName} ã®è¨ä¼ã‚’å ±å‘Šä¸­...`);
            
            if (result && result.status === 'success') {
                fetchDynamicData();
                loadingStatus.textContent = `${mobName} ã®è¨ä¼ãŒè¨˜éŒ²ã•ã‚Œã¾ã—ãŸã€‚`;
                loadingStatus.classList.remove('hidden');
                setTimeout(() => {
                    loadingStatus.classList.add('hidden');
                }, 3000);
            } else {
                loadingStatus.textContent = `ğŸš¨ è¨ä¼å ±å‘Šã«å¤±æ•—ã—ã¾ã—ãŸã€‚è©³ç´°: ${result.message || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'}`;
                loadingStatus.classList.remove('hidden');
            }
        }
        
        /**
         * GAS APIã«POSTãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
         */
        async function sendPostRequest(payload, loadingMessage) {
            loadingStatus.textContent = loadingMessage;
            loadingStatus.classList.remove('hidden');

            try {
                const response = await fetch(`${GAS_API_URL}?type=${payload.type}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload),
                    cache: 'no-cache'
                });
                
                const result = await response.json();
                
                loadingStatus.classList.add('hidden');
                return result;

            } catch (error) {
                console.error("POST Request Error:", error);
                loadingStatus.textContent = `ğŸš¨ å ±å‘Šã‚¨ãƒ©ãƒ¼: ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã¾ãŸã¯GASã®å¿œç­”ã«å¤±æ•—ã—ã¾ã—ãŸã€‚`;
                return { status: 'error', message: error.message };
            }
        }


        // ====================================================================
        // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®åˆæœŸåŒ–ã¨ãƒ¡ã‚¤ãƒ³ãƒ«ãƒ¼ãƒ—
        // ====================================================================

        /**
         * ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ¡ã‚¤ãƒ³åˆæœŸåŒ–é–¢æ•°
         */
        async function initApp(initial = true) {
            reporterUUID = getReporterUUID();
            console.log(`[Init] Reporter UUID: ${reporterUUID}`);
            console.log(`[Init] GAS API URL: ${GAS_API_URL}`);

            try {
                // 1. é™çš„ãƒ‡ãƒ¼ã‚¿ã®å–å¾— (åˆå›èµ·å‹•æ™‚ã®ã¿)
                if (initial) {
                    await fetchStaticData();
                }

                // 2. å‹•çš„ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã¨æç”»
                await fetchDynamicData();

                // 60ç§’ (60000ms) ã”ã¨ã«è‡ªå‹•æ›´æ–°ãƒ«ãƒ¼ãƒ—ã‚’è¨­å®š
                if (initial) {
                    setInterval(fetchDynamicData, 60000); 
                }
                
            } catch (error) {
                console.error("Application initialization failed.");
            }
        }

        // DOMContentLoadedå¾Œã«ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’èµ·å‹•
        window.onload = function() {
            initApp();
        };

    </script>
</body>
</html>
