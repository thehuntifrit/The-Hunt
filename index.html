<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Hunt</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-dark': '#1e293b', // Slate-800
                        'secondary-dark': '#334155', // Slate-700
                        'accent-green': '#a7f3d0', // Emerald-200 (ãƒ‘ã‚¹ãƒ†ãƒ«èª¿ã®é»„ç·‘)
                        'accent-red': '#f87171', // Red-400 for errors/warnings
                        'rank-s': '#3b82f6', // Blue-500
                        'rank-a': '#22c55e', // Green-500
                        'rank-f': '#f59e0b', // Amber-500
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        /* ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚¿ã‚¤ãƒ« */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a; /* Slate-900 (ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰èƒŒæ™¯) */
            color: #f1f5f9; /* Slate-100 */
        }

        .container {
            max-width: 100%;
            /* PC: 3ã‚«ãƒ©ãƒ ï¼ˆç´„512px x 3 + ãƒãƒ¼ã‚¸ãƒ³ï¼‰ */
            /* ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆ: 1ã‚«ãƒ©ãƒ  */
        }

        /* ãƒ¢ãƒ–ã‚«ãƒ¼ãƒ‰ã®åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ« */
        .mob-card {
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            overflow: hidden;
            background-color: #1e293b; /* primary-dark */
        }

        .mob-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2);
        }

        /* é€²è¡Œåº¦ã‚²ãƒ¼ã‚¸ï¼ˆã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³èƒŒæ™¯ï¼‰ */
        .progress-bar-bg {
            background-color: #334155; /* secondary-dark */
            position: relative;
        }

        .progress-fill {
            height: 100%;
            background-color: var(--tw-accent-green);
            transition: width 0.5s ease-out;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 10;
        }

        .progress-content {
            position: relative;
            z-index: 20;
        }

        /* æ–‡å­—ã®ã‚¢ã‚¦ãƒˆãƒ©ã‚¤ãƒ³é¢¨ã‚·ãƒ£ãƒ‰ã‚¦ (è—è‰²: #4f46e5) */
        .text-outline {
            text-shadow: 
                1px 1px 0 #4f46e5, 
                -1px -1px 0 #4f46e5, 
                1px -1px 0 #4f46e5, 
                -1px 1px 0 #4f46e5;
        }

        /* ãƒãƒƒãƒ—ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .map-container {
            position: relative;
            width: 500px;
            height: 500px;
            margin: 0 auto;
            border-radius: 0.5rem;
            overflow: hidden;
        }

        .map-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* POPåœ°ç‚¹ã®å†† */
        .pop-point {
            position: absolute;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            cursor: pointer;
            transition: background-color 0.2s;
            border: 2px solid #0f172a;
        }
        
        /* çŠ¶æ…‹åˆ¥ã‚«ãƒ©ãƒ¼ */
        .pop-candidate { background-color: #22c55e; } /* ç·‘: POPå€™è£œåœ° */
        .pop-checked { background-color: #dc2626; } /* èµ¤: POPã—ãªã‹ã£ãŸï¼ˆãƒã‚§ãƒƒã‚¯æ¸ˆã¿ï¼‰ */

        /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ã‚°ãƒªãƒƒãƒ‰ */
        .mob-grid {
            display: grid;
            gap: 1rem;
            /* ã‚¹ãƒãƒ›: 1ã‚«ãƒ©ãƒ  */
            grid-template-columns: repeat(1, minmax(0, 1fr));
        }

        @media (min-width: 768px) {
            /* ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆä»¥ä¸Š: 1ã‚«ãƒ©ãƒ  (æ¨ªå¹…ã„ã£ã±ã„) */
            .mob-grid {
                grid-template-columns: repeat(1, minmax(0, 1fr));
            }
        }

        @media (min-width: 1440px) {
            /* PC (Full HDæœ€å¤§åŒ–): 3ã‚«ãƒ©ãƒ  */
            .mob-grid {
                grid-template-columns: repeat(3, minmax(0, 512px));
                justify-content: center;
            }
        }
    </style>
</head>
<body class="min-h-screen p-4 md:p-8">

    <div id="app" class="container mx-auto">
        <h1 class="text-4xl font-extrabold text-center mb-2 text-white">The Hunt</h1>
        <p id="app-description" class="text-center text-slate-400 mb-6">
            FF14ã®ãƒ¢ãƒ–ãƒãƒ³ãƒˆã®è¨ä¼å ±å‘Šã¨POPäºˆæƒ³æ™‚åˆ»ã‚’è¿½è·¡ã—ã¾ã™ã€‚
        </p>

        <!-- ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹æƒ…å ±è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
        <div id="maintenance-info" class="text-center mb-6 p-3 rounded-lg bg-red-900/50 hidden">
            <p class="text-lg font-semibold text-accent-red"></p>
        </div>

        <!-- ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
        <div class="flex justify-center space-x-2 mb-6 p-1 bg-primary-dark rounded-lg shadow-lg">
            <!-- åˆæœŸçŠ¶æ…‹ã®ãƒœã‚¿ãƒ³ã«ã¯éã‚¢ã‚¯ãƒ†ã‚£ãƒ–æ™‚ã®ã‚¯ãƒ©ã‚¹ã‚’è¨­å®šã—ã¾ã™ -->
            <button class="tab-button px-4 py-2 rounded-md font-medium text-slate-300 hover:bg-slate-700/50 transition" data-rank="all">å…¨ã¦</button>
            <button class="tab-button px-4 py-2 rounded-md font-medium text-slate-300 hover:bg-slate-700/50 transition" data-rank="S">Sãƒ©ãƒ³ã‚¯</button>
            <button class="tab-button px-4 py-2 rounded-md font-medium text-slate-300 hover:bg-slate-700/50 transition" data-rank="A">Aãƒ©ãƒ³ã‚¯</button>
            <button class="tab-button px-4 py-2 rounded-md font-medium text-slate-300 hover:bg-slate-700/50 transition" data-rank="FATE">FATE</button>
        </div>

        <!-- ãƒ¢ãƒ–ãƒªã‚¹ãƒˆ -->
        <div id="mob-list" class="mob-grid">
            <!-- ãƒ¢ãƒ–ã‚«ãƒ¼ãƒ‰ãŒã“ã“ã«å‹•çš„ã«æŒ¿å…¥ã•ã‚Œã¾ã™ -->
            <div class="text-center p-4 text-slate-400">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­ã§ã™...</div>
        </div>

        <!-- è¨ä¼å ±å‘Šãƒ¢ãƒ¼ãƒ€ãƒ« -->
        <div id="report-modal" class="fixed inset-0 bg-black bg-opacity-75 hidden items-center justify-center p-4 z-50">
            <div class="bg-secondary-dark p-6 rounded-xl shadow-2xl w-full max-w-md">
                <h2 class="text-2xl font-bold mb-4 text-white" id="modal-mob-name"></h2>
                <p class="mb-4 text-slate-300">ãƒ¢ãƒ–ã‚’è¨ä¼ã—ãŸæ—¥æ™‚ã¨å ´æ‰€ã‚’å ±å‘Šã—ã¦ãã ã•ã„ã€‚</p>

                <div class="mb-4">
                    <label for="world-select" class="block text-sm font-medium text-slate-400 mb-1">è¨ä¼ãƒ¯ãƒ¼ãƒ«ãƒ‰</label>
                    <select id="world-select" class="w-full p-2 rounded-md bg-primary-dark border border-slate-600 text-white focus:ring-blue-500 focus:border-blue-500">
                        <!-- ãƒ¯ãƒ¼ãƒ«ãƒ‰ãƒªã‚¹ãƒˆãŒã“ã“ã«æŒ¿å…¥ã•ã‚Œã¾ã™ -->
                    </select>
                </div>

                <div class="flex justify-end space-x-3">
                    <button id="close-modal-btn" class="px-4 py-2 bg-slate-600 text-white rounded-lg hover:bg-slate-500 transition">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <button id="submit-report-btn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-500 transition">è¨ä¼å ±å‘Š</button>
                </div>
                <p id="report-message" class="mt-4 text-sm text-center hidden"></p>
            </div>
        </div>
    </div>

    <script>
        // --- è¨­å®šå®šæ•° ---
        // TODO: ãƒ‡ãƒ—ãƒ­ã‚¤ã—ãŸGASã®Web App URLã«ç½®ãæ›ãˆã¦ãã ã•ã„
        const GAS_API_URL = 'https://script.google.com/macros/s/AKfycbxyutpOIZYI9Ce51s4vawk6S460QgM4wYcaLFJKUBi00_LKhNXT9-6N0n178KdoXkP7wg/exec'; 
        // é™çš„ãƒ¢ãƒ–ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«
        const STATIC_DATA_URL = './mob_data.json';
        // ãƒ¢ãƒ–ã‚«ãƒ¼ãƒ‰ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³æ™‚é–“ (CSSã®transitionã¨ä¸€è‡´ã•ã›ã‚‹)
        const CARD_SLIDE_DURATION = 200; 

        // --- ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•° ---
        let globalMobConfig = [];
        let globalLocationDef = [];
        let globalHuntList = [];
        let globalLocationState = [];
        let globalMaintenanceInfo = null;
        let globalReporterUUID = null;
        let currentFilter = 'all';
        let currentMobToReport = null; // å ±å‘Šå¯¾è±¡ã®ãƒ¢ãƒ–

        // --- ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•° ---

        /**
         * åŒ¿åå ±å‘Šè€…ID (UUID) ã®å–å¾—ã¾ãŸã¯ç”Ÿæˆ
         * @returns {string} å ±å‘Šè€…ID
         */
        function getReporterUUID() {
            let uuid = localStorage.getItem('reporterUUID');
            if (!uuid) {
                // UUID (v4) ã‚’ç”Ÿæˆ
                uuid = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                    const r = Math.random() * 16 | 0, v = c === 'x' ? r : (r & 0x3 | 0x8);
                    return v.toString(16);
                });
                localStorage.setItem('reporterUUID', uuid);
            }
            return uuid;
        }

        /**
         * æ—¥æœ¬æ™‚é–“ (JST) ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ (ä¾‹: 10/04 18:30:00)
         * @param {Date} date - UTC Dateã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
         * @returns {string} JSTæ–‡å­—åˆ—
         */
        function formatTimeToJST(date) {
            const options = { 
                year: 'numeric', 
                month: '2-digit', 
                day: '2-digit', 
                hour: '2-digit', 
                minute: '2-digit', 
                second: '2-digit', 
                hour12: false,
                timeZone: 'Asia/Tokyo' // JST
            };
            return new Intl.DateTimeFormat('ja-JP', options).format(date);
        }

        /**
         * ç§’æ•°ã‚’ HH:MM:SS å½¢å¼ã«å¤‰æ›
         * @param {number} totalSeconds - ç§’æ•°
         * @returns {string} HH:MM:SS
         */
        function secondsToHms(totalSeconds) {
            const h = String(Math.floor(totalSeconds / 3600)).padStart(2, '0');
            const m = String(Math.floor((totalSeconds % 3600) / 60)).padStart(2, '0');
            const s = String(Math.floor(totalSeconds % 60)).padStart(2, '0');
            return `${h}:${m}:${s}`;
        }
        
        // --- ET (ã‚¨ã‚ªãƒ«ã‚¼ã‚¢æ™‚é–“) é–¢é€£ã®ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•° ---

        // ETã¨LTã®æ¯”ç‡: LT 70ç§’ = ET 3600ç§’ (1æ™‚é–“)
        const ET_RATIO = 3600 / 70; 
        const MS_PER_ET_HOUR = 70 * 1000; // 70ç§’ = 1 ETæ™‚é–“ (ãƒŸãƒªç§’)

        /**
         * ç¾å®Ÿæ™‚é–“ (Local Time: LT) ã‹ã‚‰ã‚¨ã‚ªãƒ«ã‚¼ã‚¢æ™‚é–“ (ET) ã®Dateã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’è¨ˆç®—ã™ã‚‹
         * @param {Date} ltDate - ç¾å®Ÿæ™‚é–“ï¼ˆDateã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼‰
         * @returns {Date} ã‚¨ã‚ªãƒ«ã‚¼ã‚¢æ™‚é–“ï¼ˆETï¼‰ã®Dateã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
         */
        function calculateET(ltDate) {
            // åŸºæº–æ™‚åˆ»: 2010å¹´1æœˆ1æ—¥ 00:00:00 UTC (ETã®è¨ˆç®—åŸºæº–)
            const BASE_LT = new Date('2010-01-01T00:00:00Z').getTime();
            
            // ç¾åœ¨ã®LTï¼ˆUTCãƒŸãƒªç§’ï¼‰
            const currentLT = ltDate.getTime();
            
            // åŸºæº–æ™‚ã‹ã‚‰ã®çµŒéæ™‚é–“ï¼ˆãƒŸãƒªç§’ï¼‰
            const elapsedLT = currentLT - BASE_LT;
            
            // ETã§ã®çµŒéæ™‚é–“ï¼ˆãƒŸãƒªç§’ï¼‰
            const elapsedET = elapsedLT * ET_RATIO;
            
            // ETã®Dateã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’è¨ˆç®—ï¼ˆ2010å¹´1æœˆ1æ—¥ 00:00:00ã‚’åŸºæº–ã¨ã—ãŸETæ™‚é–“ï¼‰
            const etDate = new Date(BASE_LT + elapsedET);
            
            return etDate;
        }

        /**
         * ETã®Dateã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‹ã‚‰ã€ETã®æ™‚åˆ»ï¼ˆæ™‚:åˆ†:ç§’ï¼‰ã‚’å–å¾—ã™ã‚‹
         * @param {Date} etDate - ã‚¨ã‚ªãƒ«ã‚¼ã‚¢æ™‚é–“ï¼ˆETï¼‰ã®Dateã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
         * @returns {string} ETæ™‚åˆ»æ–‡å­—åˆ— (ä¾‹: 19:30)
         */
        function getETTime(etDate) {
            // ETã¯å¸¸ã«UTCã¨ã—ã¦æ‰±ã†
            const etHour = String(etDate.getUTCHours()).padStart(2, '0');
            const etMinute = String(etDate.getUTCMinutes()).padStart(2, '0');
            return `${etHour}:${etMinute}`;
        }

        /**
         * ãƒ¢ãƒ–è¨­å®šã®ã€Œæ™‚é–“æ¡ä»¶ã€æ–‡å­—åˆ—ã‚’æº€ãŸã—ã¦ã„ã‚‹ã‹åˆ¤å®šã™ã‚‹ï¼ˆä¾‹: "19:00-21:59"ï¼‰
         */
        function isETConditionMet(conditionString, etHour) {
            // å®Ÿéš›ã«è¨ˆç®—ã§ä½¿ã†éš›ã¯ã€ã‚‚ã†å°‘ã—è¤‡é›‘ãªãƒ­ã‚¸ãƒƒã‚¯ãŒå¿…è¦ã§ã™
            return true; 
        }
        
        // --- ãƒ‡ãƒ¼ã‚¿å–å¾—ãƒ­ã‚¸ãƒƒã‚¯ ---

        /**
         * é™çš„ãƒ‡ãƒ¼ã‚¿ (mob_data.json) ã‚’å–å¾—
         */
        async function fetchStaticData() {
            try {
                const response = await fetch(STATIC_DATA_URL);
                if (!response.ok) {
                    throw new Error(`Failed to fetch static data: ${response.statusText}`);
                }
                const data = await response.json();
                
                globalMobConfig = data.mobConfig || [];
                globalLocationDef = data.locationDef || [];
                
                console.log('Static data loaded successfully.');
            } catch (error) {
                console.error('Error fetching static data:', error);
                document.getElementById('mob-list').innerHTML = '<div class="text-center p-4 text-accent-red">è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ•ã‚¡ã‚¤ãƒ«å mob_data.json ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</div>';
            }
        }

        /**
         * å‹•çš„ãƒ‡ãƒ¼ã‚¿ (Hunt_Data, Location_State, Maintenance) ã‚’GASã‹ã‚‰å–å¾—
         */
        async function fetchDynamicData() {
            try {
                // Exponential Backoff ã‚’é©ç”¨
                let result = null;
                for (let i = 0; i < 3; i++) { // æœ€å¤§3å›ã®ãƒªãƒˆãƒ©ã‚¤
                    const response = await fetch(GAS_API_URL + '?mode=getdata');
                    if (response.ok) {
                        result = await response.json();
                        break;
                    }
                    if (i < 2) {
                        await new Promise(resolve => setTimeout(resolve, (2 ** i) * 1000)); // 1s, 2s ã®å¾…æ©Ÿ
                    } else {
                        throw new Error(`GAS API fetch failed after multiple retries: ${response.statusText}`);
                    }
                }

                if (result && result.status === 'success') {
                    globalHuntList = result.huntList || [];
                    globalLocationState = result.locationState || [];
                    globalMaintenanceInfo = result.maintenance;
                    return true;
                } else if (result) {
                    console.error('GAS API Error:', result.message);
                    return false;
                }
                return false;
            } catch (error) {
                console.error('Error fetching dynamic data from GAS:', error);
                return false;
            }
        }

        // --- ãƒ¡ã‚¤ãƒ³å‡¦ç† ---

        /**
         * ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’åˆæœŸåŒ–ã—ã€ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦è¡¨ç¤º
         * @param {boolean} fetchStatic - é™çš„ãƒ‡ãƒ¼ã‚¿ã‚‚å–å¾—ã™ã‚‹ã‹ã©ã†ã‹
         */
        async function initApp(fetchStatic = true) {
            if (fetchStatic) {
                await fetchStaticData();
            }
            const success = await fetchDynamicData();
            
            if (success) {
                globalReporterUUID = getReporterUUID();
                renderMaintenanceInfo();
                renderMobList();
                
                // 30ç§’ã”ã¨ã«å‹•çš„ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
                setTimeout(() => initApp(false), 30000); // é™çš„ãƒ‡ãƒ¼ã‚¿ã¯å†å–å¾—ã—ãªã„
            } else {
                // åˆå›ãƒ­ãƒ¼ãƒ‰å¤±æ•—æ™‚ã®ã¿ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
                if (fetchStatic) {
                    document.getElementById('mob-list').innerHTML = '<div class="text-center p-4 text-accent-red">å‹•çš„ãƒ‡ãƒ¼ã‚¿ï¼ˆè¨ä¼ãƒ­ã‚°ç­‰ï¼‰ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚GASã®URLè¨­å®šã¾ãŸã¯ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</div>';
                }
            }
        }

        /**
         * ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹æƒ…å ±ã®è¡¨ç¤º
         */
        function renderMaintenanceInfo() {
            const infoDiv = document.getElementById('maintenance-info');
            const infoText = infoDiv.querySelector('p');

            if (globalMaintenanceInfo && globalMaintenanceInfo.trim() !== 'æœ€æ–°ã®ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹è¨˜äº‹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚') {
                infoText.textContent = globalMaintenanceInfo;
                infoDiv.classList.remove('hidden');
            } else {
                infoDiv.classList.add('hidden');
            }
        }

        /**
         * å…¨ãƒ¢ãƒ–ã®ãƒªã‚¹ãƒˆã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
         */
        function renderMobList() {
            const mobListContainer = document.getElementById('mob-list');
            
            // 1. å„ãƒ¢ãƒ–ã®æœ€æ–°è¨ä¼æƒ…å ±ã‚’ä»˜åŠ 
            const mobsWithInfo = globalMobConfig.map(mob => {
                const lastKills = globalHuntList
                    .filter(h => h.mobName === mob['ãƒ¢ãƒ–å'])
                    .sort((a, b) => new Date(b.killTime) - new Date(a.killTime));
                
                mob.lastKill = lastKills[0] || null;
                
                // çµŒéæ™‚é–“ã¨ãƒ‘ãƒ¼ã‚»ãƒ³ãƒ†ãƒ¼ã‚¸ã®è¨ˆç®—
                const now = Date.now();
                const repopIntervalMs = mob['ãƒªãƒãƒƒãƒ—é–“éš” (ç§’)'] * 1000;
                
                if (mob.lastKill) {
                    const killTimeMs = new Date(mob.lastKill.killTime).getTime();
                    const elapsedMs = now - killTimeMs;
                    mob.elapsedPercent = Math.min(100, (elapsedMs / repopIntervalMs) * 100);
                    mob.nextPopTime = new Date(killTimeMs + repopIntervalMs);
                } else {
                    // åˆå›ã¾ãŸã¯ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆ
                    mob.elapsedPercent = 0;
                    mob.nextPopTime = null;
                }

                // ãƒãƒƒãƒ—ã‚¢ã‚¤ã‚³ãƒ³ã®è¡¨ç¤ºåˆ¤å®š
                mob.hasMap = globalLocationDef.some(loc => loc.mobName === mob['ãƒ¢ãƒ–å']);
                
                // æ—¥æœ¬èªã‚­ãƒ¼ã‚’å®‰å…¨ã«å‚ç…§
                mob.mapFileName = mob['ãƒãƒƒãƒ—ç”»åƒ (ãƒ•ã‚¡ã‚¤ãƒ«å)'];

                return mob;
            });
            
            // 2. çµŒéæ™‚é–“%ã§é™é †ã‚½ãƒ¼ãƒˆ
            mobsWithInfo.sort((a, b) => b.elapsedPercent - a.elapsedPercent);
            
            // 3. ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
            const filteredMobs = mobsWithInfo.filter(mob => 
                currentFilter === 'all' || mob['ãƒ©ãƒ³ã‚¯'] === currentFilter
            );

            // 4. HTMLç”Ÿæˆ
            mobListContainer.innerHTML = '';
            if (filteredMobs.length === 0) {
                 mobListContainer.innerHTML = '<div class="text-center p-4 text-slate-400">è©²å½“ã™ã‚‹ãƒ¢ãƒ–ãŒã„ã¾ã›ã‚“ã€‚</div>';
            } else {
                filteredMobs.forEach(mob => {
                    const cardHtml = createMobCard(mob);
                    mobListContainer.insertAdjacentHTML('beforeend', cardHtml);
                });
            }
            
            // 5. ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®å†è¨­å®š
            setupEventListeners();
        }

        /**
         * å€‹åˆ¥ã®ãƒ¢ãƒ–ã‚«ãƒ¼ãƒ‰HTMLã‚’ç”Ÿæˆ
         * @param {Object} mob - ãƒ¢ãƒ–ãƒ‡ãƒ¼ã‚¿ã¨è¨ˆç®—çµæœã‚’å«ã‚€ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
         */
        function createMobCard(mob) {
            const rankColor = {
                'S': 'bg-rank-s',
                'A': 'bg-rank-a',
                'FATE': 'bg-rank-f',
                'ãªã—': 'bg-slate-500'
            }[mob['ãƒ©ãƒ³ã‚¯']] || 'bg-slate-500';

            const nextPopDisplay = mob.nextPopTime 
                ? formatTimeToJST(mob.nextPopTime)
                : 'ä¸æ˜ (åˆå ±æ±‚ã‚€)';

            const elapsedDuration = mob.lastKill
                ? secondsToHms(Math.max(0, (Date.now() - new Date(mob.lastKill.killTime).getTime()) / 1000))
                : '---';

            const lastKillDisplay = mob.lastKill 
                ? formatTimeToJST(new Date(mob.lastKill.killTime)) 
                : '---';

            const mapIcon = mob.hasMap ? ' ğŸ—ºï¸' : '';
            
            // ãƒãƒƒãƒ—è¡¨ç¤ºã‚¨ãƒªã‚¢ã®ID
            const mapAreaId = `map-area-${mob['ãƒ¢ãƒ–å'].replace(/\s/g, '-')}`;

            return `
                <div class="mob-card rounded-xl shadow-xl transition-all duration-300" data-mob-name="${mob['ãƒ¢ãƒ–å']}" data-rank="${mob['ãƒ©ãƒ³ã‚¯']}">
                    <!-- ä¸Šéƒ¨ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¨ãƒªã‚¢ -->
                    <div class="progress-bar-bg p-4 rounded-t-xl overflow-hidden relative" data-percent="${mob.elapsedPercent}">
                        <div class="progress-fill bg-accent-green" style="width: ${mob.elapsedPercent}%;"></div>
                        <div class="progress-content relative flex flex-col space-y-2">
                            <div class="flex justify-between items-start">
                                <!-- ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼å, ã‚¨ãƒªã‚¢å -->
                                <div class="flex flex-col">
                                    <div class="flex items-center space-x-2">
                                        <span class="text-2xl font-bold text-outline text-white">${mob['ãƒ¢ãƒ–å']}${mapIcon}</span>
                                        <!-- ãƒãƒƒãƒ—ã‚¢ã‚¤ã‚³ãƒ³ãƒ›ãƒãƒ¼è¡¨ç¤º -->
                                        ${mob.hasMap ? `<span class="map-icon text-lg cursor-pointer" data-mob-name="${mob['ãƒ¢ãƒ–å']}" title="POPåœ°ç‚¹ãƒãƒƒãƒ—ã‚’è¡¨ç¤º">ğŸ—ºï¸</span>` : ''}
                                    </div>
                                    <span class="text-lg font-medium text-slate-300">${mob['ã‚¨ãƒªã‚¢å']}</span>
                                </div>
                                <!-- ãƒ©ãƒ³ã‚¯ã¨å ±å‘Šãƒœã‚¿ãƒ³ -->
                                <div class="flex flex-col items-end space-y-1">
                                    <span class="px-2 py-1 text-sm font-semibold rounded-full text-white ${rankColor}">${mob['ãƒ©ãƒ³ã‚¯']}</span>
                                    <button class="report-btn px-3 py-1 text-sm bg-indigo-600 text-white rounded-lg hover:bg-indigo-500 transition">å ±å‘Š</button>
                                </div>
                            </div>
                            <!-- æ¬¡å›POPæ™‚é–“ (çµŒé%) -->
                            <div class="text-sm font-semibold text-white">
                                <p>æ¬¡å›POPäºˆæƒ³: ${nextPopDisplay}</p>
                                <p>çµŒé: ${elapsedDuration} (${mob.elapsedPercent.toFixed(1)}%)</p>
                            </div>
                        </div>
                    </div>

                    <!-- è©³ç´°ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚¨ãƒªã‚¢ -->
                    <div class="detail-content overflow-hidden max-h-0 transition-all duration-500 bg-secondary-dark rounded-b-xl">
                        <div class="p-4 space-y-3">
                            <!-- å‰å›ã®è¨ä¼æ™‚é–“ -->
                            <div>
                                <p class="text-sm text-slate-400">å‰å›ã®è¨ä¼æ™‚é–“ (JST):</p>
                                <p class="text-lg font-semibold text-white">${lastKillDisplay}</p>
                            </div>
                            <!-- POPã•ã›ã‚‹æ¡ä»¶ã®èª¬æ˜ -->
                            <div>
                                <p class="text-sm text-slate-400">POPæ¡ä»¶:</p>
                                <p class="text-lg font-semibold text-white">${mob['POPæ¡ä»¶'] || 'ãªã—'}</p>
                                <p class="text-sm text-slate-300">æ™‚é–“æ¡ä»¶: ${mob['æ™‚é–“æ¡ä»¶'] || 'å¸¸æ™‚'}</p>
                                <p class="text-sm text-slate-300">å¤©å€™æ¡ä»¶: ${mob['å¤©å€™æ¡ä»¶'] || 'å…¨ã¦'}</p>
                            </div>

                            <!-- åº§æ¨™è¨˜éŒ²ç”¨ã®MAP (ã“ã“ã«ãƒãƒƒãƒ—ãŒæç”»ã•ã‚Œã¾ã™) -->
                            <div class="map-section">
                                <p class="text-sm text-slate-400 mb-2">POPåœ°ç‚¹ãƒˆãƒ©ãƒƒã‚«ãƒ¼:</p>
                                <div id="${mapAreaId}" class="map-container hidden">
                                    <!-- ãƒãƒƒãƒ—ç”»åƒã¨POPç‚¹ãŒJSã«ã‚ˆã£ã¦æŒ¿å…¥ã•ã‚Œã¾ã™ -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        /**
         * ãƒãƒƒãƒ—ã‚³ãƒ³ãƒ†ãƒŠã«ç”»åƒã¨POPåœ°ç‚¹ã‚’å‹•çš„ã«æç”»
         * @param {string} mobName - ãƒ¢ãƒ–å
         */
        function renderMap(mobName) {
            const mob = globalMobConfig.find(m => m['ãƒ¢ãƒ–å'] === mobName);
            const mapContainer = document.getElementById(`map-area-${mobName.replace(/\s/g, '-')}`);
            
            // æ—¥æœ¬èªã‚­ãƒ¼ã‚’å®‰å…¨ã«å‚ç…§
            const mapFileName = mob ? mob['ãƒãƒƒãƒ—ç”»åƒ (ãƒ•ã‚¡ã‚¤ãƒ«å)'] : null;

            if (!mob || !mapFileName) {
                mapContainer.innerHTML = '<p class="text-slate-500 text-center py-4">ãƒãƒƒãƒ—ç”»åƒãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</p>';
                mapContainer.classList.remove('hidden');
                return;
            }

            // ãƒãƒƒãƒ—ç”»åƒãƒ‘ã‚¹ã¯ 'Picture' ãƒ•ã‚©ãƒ«ãƒ€ã‚’ä½¿ç”¨
            const imagePath = `./Picture/${mapFileName}`;

            // ãƒãƒƒãƒ—ã®å®šç¾©æ¸ˆã¿åº§æ¨™ã‚’å–å¾—
            const definedLocations = globalLocationDef.filter(loc => loc.mobName === mobName);
            
            // ç¾åœ¨ã®ãƒã‚§ãƒƒã‚¯æ¸ˆã¿çŠ¶æ…‹ã‚’å–å¾— (Location_State)
            const checkedStates = globalLocationState
                .filter(state => state.mobName === mobName)
                .map(state => state.checkedLocationId);

            let mapHtml = `<img src="${imagePath}" class="map-image" onerror="this.onerror=null; this.src='https://placehold.co/500x500/1e293b/94a3b8?text=Map+Not+Found'" alt="${mob['ã‚¨ãƒªã‚¢å']} Map">`;
            
            definedLocations.forEach(loc => {
                const isChecked = checkedStates.includes(loc.locationId);
                // ãƒã‚§ãƒƒã‚¯æ¸ˆã¿ãªã‚‰èµ¤ (POPã—ãªã‹ã£ãŸ)
                const stateClass = isChecked ? 'pop-checked' : 'pop-candidate'; 
                
                // åº§æ¨™ã‚’ãƒ‘ãƒ¼ã‚»ãƒ³ãƒ†ãƒ¼ã‚¸ã§è¨ˆç®— (ç”»åƒã‚µã‚¤ã‚º 500x500 ã‚’ä»®å®š)
                const xPercent = (loc.coordX / 500) * 100;
                const yPercent = (loc.coordY / 500) * 100;

                mapHtml += `
                    <div class="pop-point ${stateClass}" 
                         style="left: ${xPercent}%; top: ${yPercent}%; transform: translate(-50%, -50%);"
                         data-mob-name="${mobName}"
                         data-location-id="${loc.locationId}"
                         data-checked="${isChecked}">
                    </div>
                `;
            });

            mapContainer.innerHTML = mapHtml;
            mapContainer.classList.remove('hidden');
            
            // POPåœ°ç‚¹ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š
            mapContainer.querySelectorAll('.pop-point').forEach(point => {
                point.addEventListener('click', handlePopPointClick);
            });
        }


        /**
         * POPåœ°ç‚¹ã‚¯ãƒªãƒƒã‚¯æ™‚ã®å‡¦ç†ï¼ˆãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³ï¼‰
         */
        function handlePopPointClick(event) {
            const point = event.currentTarget;
            const mobName = point.getAttribute('data-mob-name');
            const locationId = point.getAttribute('data-location-id');
            const isChecked = point.getAttribute('data-checked') === 'true';

            if (isChecked) {
                console.log(`Location ${locationId} for ${mobName} is already checked. Skipping submission.`);
                return;
            }
            
            // ã‚«ã‚¹ã‚¿ãƒ ãƒ¢ãƒ¼ãƒ€ãƒ« UI ã‚’ä½¿ç”¨ã™ã‚‹ä»£ã‚ã‚Šã«ã€ä»Šå›ã¯ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‡ºåŠ›ã—ã¦å‡¦ç†ã‚’ç¶šè¡Œã—ã¾ã™
            console.log(`${mobName}ã®åº§æ¨™ ${locationId} ã‚’ã€ŒPOPã—ãªã‹ã£ãŸå ´æ‰€ã€ã¨ã—ã¦è¨˜éŒ²ã‚’è©¦ã¿ã¾ã™ã€‚`);

            // GASã¸ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚’é€ä¿¡
            sendLocationState({
                mobName: mobName,
                locationId: locationId,
                reporterId: globalReporterUUID
            });
        }

        /**
         * è¨ä¼å ±å‘Šã¾ãŸã¯åº§æ¨™ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚’GASã«é€ä¿¡
         * @param {Object} data - é€ä¿¡ã™ã‚‹ãƒ‡ãƒ¼ã‚¿
         * @param {string} type - 'kill' ã¾ãŸã¯ 'location'
         */
        async function sendDataToGas(data, type) {
            const url = GAS_API_URL + '?mode=post&type=' + type;
            try {
                // Exponential Backoff ã‚’é©ç”¨
                let result = null;
                for (let i = 0; i < 3; i++) {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                    
                    if (response.ok) {
                        result = await response.json();
                        break;
                    }
                    if (i < 2) {
                        await new Promise(resolve => setTimeout(resolve, (2 ** i) * 1000));
                    } else {
                         throw new Error(`GAS API post failed after multiple retries: ${response.statusText}`);
                    }
                }
                
                if (result && result.status === 'success') {
                    console.log(`${type} report success.`);
                    // æˆåŠŸã—ãŸã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å†å–å¾—ã—ã¦ãƒªã‚¹ãƒˆã‚’æ›´æ–°
                    await fetchDynamicData();
                    renderMobList();
                    return true;
                } else if (result) {
                    console.error(`${type} report failed:`, result.message);
                    return false;
                }
                return false;
            } catch (error) {
                console.error(`Error sending ${type} data to GAS:`, error);
                return false;
            }
        }

        /**
         * åº§æ¨™ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚’GASã«é€ä¿¡
         */
        function sendLocationState(data) {
            // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ 'checked' ã§é€ä¿¡ (GASå´ã§ Location_State ã«æ›¸ãè¾¼ã¿)
            sendDataToGas(data, 'location'); 
        }

        /**
         * è¨ä¼å ±å‘Šãƒ‡ãƒ¼ã‚¿ã‚’GASã«é€ä¿¡
         */
        async function submitKillReport(mobName, world) {
            const mob = globalMobConfig.find(m => m['ãƒ¢ãƒ–å'] === mobName);
            if (!mob) return false;

            const killReportData = {
                mobName: mobName,
                mobRank: mob['ãƒ©ãƒ³ã‚¯'],
                area: mob['ã‚¨ãƒªã‚¢å'],
                world: world,
                reporterId: globalReporterUUID,
            };

            const success = await sendDataToGas(killReportData, 'kill');

            const messageEl = document.getElementById('report-message');
            messageEl.classList.remove('hidden');

            if (success) {
                messageEl.textContent = `${mobName}ã®è¨ä¼ã‚’å ±å‘Šã—ã¾ã—ãŸã€‚ãƒãƒƒãƒ—çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸã€‚`;
                messageEl.classList.add('text-green-400');
                messageEl.classList.remove('text-accent-red');
            } else {
                messageEl.textContent = 'å ±å‘Šã«å¤±æ•—ã—ã¾ã—ãŸã€‚GASã®ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
                messageEl.classList.remove('text-green-400');
                messageEl.classList.add('text-accent-red');
            }
            
            // ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒé–‰ã˜ãŸã‚‰ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ãƒªã‚»ãƒƒãƒˆ
            return success;
        }

        /**
         * ã‚¿ãƒ–ãƒœã‚¿ãƒ³ã®CSSã‚¯ãƒ©ã‚¹ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹
         * @param {HTMLElement} button - å¯¾è±¡ã®ãƒœã‚¿ãƒ³è¦ç´ 
         * @param {boolean} isActive - ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã‹ã©ã†ã‹
         */
        function toggleActiveClass(button, isActive) {
            const activeClasses = ['bg-accent-green', 'text-primary-dark', 'shadow-inner'];
            const inactiveClasses = ['text-slate-300', 'hover:bg-slate-700/50'];

            if (isActive) {
                button.classList.add(...activeClasses);
                button.classList.remove(...inactiveClasses);
            } else {
                button.classList.remove(...activeClasses);
                button.classList.add(...inactiveClasses);
            }
        }

        // --- ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©è¨­å®š ---
        function setupEventListeners() {
            // 1. ã‚«ãƒ¼ãƒ‰ã‚¯ãƒªãƒƒã‚¯æ™‚ã®è©³ç´°è¡¨ç¤º/éè¡¨ç¤º
            document.querySelectorAll('.mob-card').forEach(card => {
                const detailContent = card.querySelector('.detail-content');
                const mobName = card.getAttribute('data-mob-name');
                const mapArea = card.querySelector(`#map-area-${mobName.replace(/\s/g, '-')}`);

                // è©³ç´°ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã® max-height ã‚’ãƒªã‚»ãƒƒãƒˆ
                detailContent.style.maxHeight = '0';
                mapArea.classList.add('hidden');

                card.addEventListener('click', function(e) {
                    // å ±å‘Šãƒœã‚¿ãƒ³ã‚„ãƒãƒƒãƒ—ã‚¢ã‚¤ã‚³ãƒ³ã€POPåœ°ç‚¹ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸå ´åˆã¯å‡¦ç†ã‚’ã‚¹ã‚­ãƒƒãƒ—
                    if (e.target.closest('.report-btn') || e.target.closest('.map-icon') || e.target.closest('.pop-point')) {
                        return;
                    }

                    const isExpanded = detailContent.classList.contains('is-expanded');
                    
                    if (isExpanded) {
                        detailContent.style.maxHeight = '0';
                        detailContent.classList.remove('is-expanded');
                        mapArea.classList.add('hidden');
                    } else {
                        // ãƒãƒƒãƒ—ã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
                        renderMap(mobName);
                        
                        // æœ€å¤§é«˜ã•ã‚’è¨ˆç®—ã—ã¦å±•é–‹ (scrollHeightã‚’ä½¿ã†)
                        // ãƒãƒƒãƒ—ãŒå±•é–‹ã•ã‚Œã‚‹å‰ã«è¨ˆç®—ã™ã‚‹ã¨é«˜ã•ãŒè¶³ã‚Šãªããªã‚‹ãŸã‚ã€å°‘ã—é…å»¶ã•ã›ã‚‹ã‹ã€scrollHeightã‚’æ­£ã—ãå–å¾—ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
                        // ä»Šå›ã¯ mapArea ã® height (500px) + padding/margin ã‚’æ¦‚ç®—ã—ã¦å¤šã‚ã«è¨­å®šã—ã¾ã™
                        const requiredHeight = detailContent.scrollHeight + 550; // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒã‚¤ãƒˆ + ãƒãƒƒãƒ—ã®æœ€å¤§é«˜ã•
                        detailContent.style.maxHeight = requiredHeight + "px";
                        detailContent.classList.add('is-expanded');
                    }
                });
            });

            // 2. å ±å‘Šãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯æ™‚ã®ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
            document.querySelectorAll('.report-btn').forEach(btn => {
                btn.onclick = function(e) {
                    e.stopPropagation(); // ã‚«ãƒ¼ãƒ‰ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã®ä¼æ’­ã‚’åœæ­¢
                    const card = e.target.closest('.mob-card');
                    currentMobToReport = card.getAttribute('data-mob-name');
                    document.getElementById('modal-mob-name').textContent = `${currentMobToReport} ã®è¨ä¼å ±å‘Š`;
                    document.getElementById('report-modal').classList.remove('hidden');
                    document.getElementById('report-modal').classList.add('flex');
                    document.getElementById('report-message').classList.add('hidden');
                    
                    // ãƒ¯ãƒ¼ãƒ«ãƒ‰ãƒªã‚¹ãƒˆã®ç”Ÿæˆ (ã“ã“ã§ã¯ãƒ€ãƒŸãƒ¼ã€‚å¿…è¦ã«å¿œã˜ã¦å¤‰æ›´ã—ã¦ãã ã•ã„)
                    const worldSelect = document.getElementById('world-select');
                    worldSelect.innerHTML = `
                        <option value="Elemental">Elemental</option>
                        <option value="Gaia">Gaia</option>
                        <option value="Mana" selected>Mana</option>
                        <option value="Meteor">Meteor</option>
                    `;
                };
            });

            // 3. ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒœã‚¿ãƒ³
            document.querySelectorAll('.tab-button').forEach(btn => {
                const rank = btn.getAttribute('data-rank');

                // åˆæœŸçŠ¶æ…‹ãƒ»æ›´æ–°å¾Œã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã®è¨­å®š
                toggleActiveClass(btn, rank === currentFilter);

                btn.onclick = function() {
                    if (rank === currentFilter) return; // ã™ã§ã«é¸æŠã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ä½•ã‚‚ã—ãªã„
                    
                    currentFilter = rank;
                    
                    // å…¨ãƒœã‚¿ãƒ³ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã‚’æ›´æ–°
                    document.querySelectorAll('.tab-button').forEach(b => {
                        toggleActiveClass(b, b === btn);
                    });
                    
                    // ãƒ¢ãƒ–ãƒªã‚¹ãƒˆã‚’å†æç”»
                    renderMobList();
                };
            });

            // 4. ãƒ¢ãƒ¼ãƒ€ãƒ«æ“ä½œ
            document.getElementById('close-modal-btn').onclick = () => {
                document.getElementById('report-modal').classList.add('hidden');
                document.getElementById('report-modal').classList.remove('flex');
                currentMobToReport = null;
            };

            document.getElementById('submit-report-btn').onclick = async () => {
                const world = document.getElementById('world-select').value;
                const success = await submitKillReport(currentMobToReport, world);
                
                // æˆåŠŸã—ãŸã‚‰è‡ªå‹•çš„ã«ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
                if (success) {
                     setTimeout(() => {
                        document.getElementById('report-modal').classList.add('hidden');
                        document.getElementById('report-modal').classList.remove('flex');
                     }, 1500);
                }
            };
        }

        // åˆæœŸåŒ–å®Ÿè¡Œ
        window.onload = function() {
            initApp();
        };

    </script>
</body>
</html>
